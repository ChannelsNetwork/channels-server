<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../bower_components/polymer/lib/utils/import-href.html">
<link rel="import" href="../bower_components/soso-pages/soso-pages.html">
<link rel="import" href="../bower_components/soso-router/soso-router.html">
<link rel="import" href="core/core.html">
<link rel="import" href="app-styles.html">
<link rel="import" href="app-bar.html">

<dom-module id="main-app">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        position: relative;
        height: 100%;
        padding-top: 60px;
        box-sizing: border-box;
        transition: padding 0.5s ease;
      }

      soso-pages {
        display: block;
        position: relative;
        overflow: initial;
      }

      app-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
      }

      #reloadingPanel {
        position: fixed;
        z-index: 100;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        color: inherit;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-align: center;
      }

      terms-panel {
        position: fixed;
        bottom: 0;
        right: 0;
        box-shadow: 0 -1px 6px -1px rgba(0, 0, 0, 0.6);
        margin: 5px;
        box-sizing: border-box;
        border-radius: 3px;
      }
    </style>

    <soso-pages id="pages">
      <div class="page"></div>
      <!-- Signin and registartion pages -->
      <sign-in-view class="signin page" data-href="account/sign-in-view.html"></sign-in-view>
      <register-view class="register page" data-href="account/register-view.html"></register-view>
      <register-image-view class="register-photo page" data-href="account/register-image-view.html"></register-image-view>
      <request-recovery-view class="request-recovery page" data-href="account/request-recovery-view.html"></request-recovery-view>
      <recover-account-view class="recover page" data-href="account/recover-account-view.html"></recover-account-view>
      <!-- Account Pages -->
      <account-view class="account page" data-toolbar="true" data-href="account/account-view.html"></account-view>
      <edit-profile-view class="edit-profile page" data-href="account/edit-profile-view.html"></edit-profile-view>
      <!-- About Pages -->
      <about-view class="about page" data-toolbar="true" data-href="about/about-view.html"></about-view>
      <learn-card-development-view class="learn-card-development page" data-toolbar="true" data-href="about/learn-card-development-view.html"></learn-card-development-view>
      <!-- Balance Pages -->
      <balance-view class="balance page" data-toolbar="true" data-href="balance/balance-view.html"></balance-view>
      <withdraw-dialog class="withdraw page" data-href="balance/withdraw-dialog.html"></withdraw-dialog>
      <!-- Feed/Card Pages -->
      <feed-view id="feed" class="feed page" data-toolbar="true" data-href="feed/feed-view.html"></feed-view>
      <channel-view class="channel page" data-toolbar="true" data-href="feed/channel-view.html"></channel-view>
      <search-view id="search" class="search page" data-toolbar="true" data-href="feed/search-view.html"></search-view>
      <browse-view id="browse" class="browse page" data-toolbar="true" data-href="feed/browse-view.html"></browse-view>
      <compose-view class="compose page" data-href="compose/compose-view.html"></compose-view>
      <card-page class="card page" data-toolbar="true" data-preventscroll="true" data-href="card/card-page.html"></card-page>
      <!-- Test pages -->
      <test-page class="test page" data-href="obsolete/test-page.html"></test-page>
      <admin-users-view class="admin-users page" data-href="admin/admin-users-view.html"></admin-users-view>
      <admin-cards-view class="admin-cards page" data-href="admin/admin-cards-view.html"></admin-cards-view>
      <admin-goals-view class="admin-goals page" data-href="admin/admin-goals-view.html"></admin-goals-view>
      <admin-withdrawals-view class="admin-withdrawals page" data-href="admin/admin-withdrawals-view.html"></admin-withdrawals-view>
    </soso-pages>
    <terms-panel id="termsPanel" class="hidden" on-tncs-agreed="_onTermsAgreed"></terms-panel>
    <app-bar id="toolbar"></app-bar>

    <div id="reloadingPanel" class="horizontal layout center hidden">
      <div style="width: 100%; box-sizing: border-box;">Channels is updating</div>
    </div>
    <confirm-dialog id="dlgConfirm"></confirm-dialog>
    <error-dialog id="dlgError"></error-dialog>

    <soso-router id="router" on-route-change="_onRouteChange"></soso-router>
  </template>
  <script>
    class MainApp extends Polymer.Element {
      static get is() { return 'main-app'; }

      constructor() {
        super();
        window.$app = this;
        window.$core = new CoreService();
        this._barShowing = true;
        this._homePanelVisible = false;
      }

      connectedCallback() {
        super.connectedCallback();
        window.$router = this.$.router;
        const tp = document.getElementById("temp-panel");
        if (tp) {
          tp.style.display = "none";
        }
        window.addEventListener('channels-server-version-change', () => {
          this.$.reloadingPanel.classList.remove("hidden");
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        });
      }

      _onRouteChange(event) {
        let cb = (event) => {
          const pageName = this._handleRouteChange(event.detail.route);
          if ((pageName === 'card') && (!$core.isAgreedToTnCs())) {
            return this._import("account/terms-panel.html").then(() => {
              this.$.termsPanel.classList.remove("hidden");
            });
          }
        };
        if (this._lastPage && this._lastPath && this._lastPage.validatePageChange) {
          this._lastPage.validatePageChange(event).then((proceed) => {
            if (proceed) {
              cb(event);
            } else {
              window.history.pushState(null, null, this._lastPath);
            }
          }).catch((err) => {
            if (err) console.warn(err);
            cb(event);
          })
        } else {
          cb(event);
        }
      }

      _onTermsAgreed() {
        $core.agreeToTnCs();
        this.$.termsPanel.classList.add("hidden");
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      _handleRouteChange(route) {
        let segments = route.segments;
        let pageName = segments[0] || "feed";
        if (pageName === 'c') {
          pageName = "card";
        }
        const pages = this.shadowRoot.querySelectorAll(".page");
        let activePage = this.shadowRoot.querySelector("." + pageName);
        if (!activePage) {
          activePage = this.$.feed;
          pageName = "feed";
        }
        let activeIndex = 0;
        for (let i = 0; i < pages.length; i++) {
          if (activePage == pages[i]) {
            activeIndex = i;
            break;
          }
        }

        // close pending dialogs
        let dlgShell = document.getElementById("dialogShell");
        if (dlgShell) {
          this._clearNode(dlgShell);
        }

        // Notify prev page it's being hidden
        if (this._lastPage) {
          if (this._lastPage != activePage) {
            this._lastPage.style.display = "";
            if (this._lastPage.onDeactivate) {
              try {
                this._lastPage.onDeactivate();
              } catch (err) { console.error("Error in page deactivate", err); }
            }
          }
        }

        // home pane visibility
        const homePanel = document.getElementById("homePanel");
        let homePanelVisible = false;
        if (homePanel) {
          if (pageName === 'feed') {
            let feedType = segments[1];
            if ((!feedType) || (feedType === 'recommended')) {
              homePanelVisible = true;
            }
          }
          if (homePanelVisible) {
            homePanelVisible = !($core.storage.getItem("homePanelState") === 'closed');
          }
          homePanel.style.display = homePanelVisible ? "block" : "none";
          homePanel.style.borderBottom = "1px solid #e5e5e5";
        }
        let hpc = document.getElementById("homePanelClose");
        if (hpc) {
          hpc.style.display = "block";
        }
        this._homePanelVisible = homePanelVisible;

        const showToolbar = activePage.dataset.toolbar == "true";
        const forcePreventScroll = activePage.dataset.preventscroll === "true";
        this._preventScroll = forcePreventScroll || (!showToolbar);
        this.style.paddingTop = (showToolbar && (!homePanelVisible)) ? "60px" : "0";
        const pageHref = activePage.dataset.href;
        let animation = route.animation;
        if (!animation) {
          if (this._lastPage) {
            let lpa = this._lastPage.dataset.animationOut;
            if (lpa) {
              animation = lpa;
            }
          }
        }
        animation = animation || activePage.dataset.animationIn || "none";
        this.$.pages.animation = animation;
        this._setBarVisible(showToolbar);

        this._lastPage = activePage;
        this._lastPath = route.path;
        const pageCallback = () => {
          this.$.pages.selectedIndex = activeIndex;
          setTimeout(() => {
            if (activePage.onActivate) {
              activePage.onActivate(route);
            }
          }, 10);
        };
        if (pageHref) {
          Polymer.importHref(this.resolveUrl(pageHref), pageCallback);
        } else {
          pageCallback();
        }

        // scroll to top
        this.scrollTo(0);
        this._prevScrollValue = 0;
        this._attachScrollListener();

        // notify toolbar
        this.$.toolbar.onRoute(route);

        // notify analytics
        $core.analytics.page(window.location.pathname || "/");

        return pageName;
      }

      _attachScrollListener() {
        if (!this._scrollListener) {
          this._scrollListener = (event) => {
            if (!this._preventScroll) {
              this._onScroll(event);
            }
          };
          document.addEventListener("scroll", this._scrollListener);
        }
      }

      _onScroll(event) {
        let st = this.scrollValue;
        if (!this._prevScrollValue) {
          this._prevScrollValue = st;
        } else {
          if (st <= 0) {
            this._prevScrollValue = 0;
            if (!this._barShowing) {
              this._setBarVisible(true);
            }
            return;
          }
          let diff = st - this._prevScrollValue;
          if (diff > 10) {
            this._prevScrollValue = st;
            if (this._barShowing) {
              this._setBarVisible(false);
            }
          } else if (diff < -5) {
            this._prevScrollValue = st;
            if (!this._barShowing) {
              this._setBarVisible(true);
            }
          }
        }
      }

      _setBarVisible(visible) {
        this._barShowing = visible;
        this.$.toolbar.style.top = visible ? "0px" : "-105px";
      }

      _import(path) {
        return new Promise((resolve, reject) => {
          Polymer.importHref(this.resolveUrl(path), () => {
            resolve();
          }, (err) => {
            reject(err);
          });
        });
      }

      confirm(message, cancelText, okText) {
        return this._import("dialogs/confirm-dialog.html").then(() => {
          return this.$.dlgConfirm.show(message, cancelText, okText);
        });
      }

      showError(error) {
        let message = error.message || error.toString();
        return this._import("dialogs/error-dialog.html").then(() => {
          return this.$.dlgError.show(message);
        });
      }

      get scrollValue() {
        return (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement.scrollTop || document.body.scrollTop);
      }

      get homePanelVisible() {
        return this._homePanelVisible
      }

      scrollTo(value) {
        if (window.scrollTo) {
          window.scrollTo(0, value);
        } else {
          document.documentElement.scrollTop = value;
          document.body.scrollTop = value;
        }
      }
    }
    window.customElements.define(MainApp.is, MainApp);
  </script>
</dom-module>