<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/soso-truncated-text/soso-truncated-text.html">
<link rel="import" href="../controls/user-image.html">

<dom-module id="carousel-cell">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #container {
        height: 100%;
        background-color: #f0f0f0;
        background-size: cover;
        background-origin: border-box;
        background-position: 50% 50%;
        position: relative;
        text-align: center;
      }

      #overlay {
        background: rgba(0, 0, 0, 0.6);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        cursor: pointer;
      }

      #overlay:hover {
        box-shadow: 10px 0px 0px 0 rgba(255, 255, 255, 0.7) inset;
      }

      #overlay.selected {
        box-shadow: 10px 0px 0px 0 rgba(255, 233, 99, 1) inset;
      }

      #overlay.selected:hover {
        box-shadow: 10px 0px 0px 0 rgba(255, 233, 99, 1) inset;
      }

      .label {
        width: 100%;
        box-sizing: border-box;
        padding: 5px 5px 5px 10px;
        color: white;
        font-weight: bold;
        letter-spacing: 0.05em;
        font-size: 20px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
    <div id="container">
      <div id="overlay" class="horizontal layout center">
        <span class="label">[[channel.name]]</span>
      </div>
    </div>
  </template>
  <script>
    class CarouselCell extends Polymer.Element {
      static get is() { return 'carousel-cell'; }
      static get properties() {
        return {
          channel: {
            type: Object,
            observer: '_onChannel'
          },
          selected: {
            type: Boolean,
            observer: '_onSelection'
          }
        }
      }
      connectedCallback() {
        super.connectedCallback();
        this._onChannel();
        this._onSelection();
      }
      _onChannel() {
        if (this.channel) {
          let image = this.channel.owner.image ? this.channel.owner.image.url : "";
          this.$.container.style.backgroundImage = 'url("' + (image || '') + '")';
        }
      }
      _onSelection() {
        if (this.$.overlay) {
          if (this.selected) {
            this.$.overlay.classList.add("selected");
          } else {
            this.$.overlay.classList.remove("selected");
          }
        }
      }
    }
    window.customElements.define(CarouselCell.is, CarouselCell);
  </script>
</dom-module>

<dom-module id="channel-carousel">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        max-width: 1200px;
        margin: 0 auto;
        border-radius: 3px;
        overflow: hidden;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      #rightPanel {
        width: 200px;
      }

      #container {
        min-height: 400px;
      }

      .cell {
        min-height: 100px;
      }

      .panel {
        background-color: #fff;
        background-size: cover;
        background-origin: border-box;
        background-position: 50% 50%;
      }

      user-image {
        width: 90px;
        height: 90px;
        border: 5px solid #fafafa;
        border-radius: 50%;
        background: #fafafa;
      }

      .imageCell {
        padding: 0 16px 0;
      }

      .title {
        font-size: 35px;
      }

      .description {
        font-size: 24px;
      }

      .gradient {
        background: rgba(0, 0, 0, 0.45);
        background: -webkit-linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.45));
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.45));
      }

      .content {
        padding: 20px 0;
        color: white;
        background: rgba(0, 0, 0, 0.45);
      }

      .realContent {
        transition: opacity 0.3s ease;
      }

      .transparent .realContent {
        opacity: 0;
      }

      .textPanel {
        padding-right: 16px;
      }

      soso-truncated-text {
        max-height: 120px;
      }
    </style>
    <div id="container" class="horizontal layout">
      <dom-repeat items="[[channels]]">
        <template>
          <div data-id$="[[item.id]]" class="flex vertical layout panel hidden" style$="[[getBg(item)]]">
            <div class="flex gradient"></div>
            <div class="content horizontal layout">
              <div class="imageCell">
                <user-image class="realContent" image="[[getChannelImage(item)]]"></user-image>
              </div>
              <div class="flex realContent textPanel">
                <div class="title">[[item.name]]</div>
                <soso-truncated-text class="description" text="[[item.about]]"></soso-truncated-text>
              </div>
            </div>
          </div>
        </template>
      </dom-repeat>
      <div id="rightPanel" class="vertical layout">
        <dom-repeat items="[[channels]]">
          <template>
            <carousel-cell on-click="_onCellClick" data-id$="[[item.id]]" class="cell flex" channel="[[item]]"></carousel-cell>
          </template>
        </dom-repeat>
      </div>
    </div>
  </template>
  <script>
    class ChannelCarousel extends Polymer.Element {
      static get is() { return 'channel-carousel'; }
      static get properties() {
        return {
          channels: Array,
          selected: {
            type: Number,
            observer: '_onSelected'
          }
        };
      }

      constructor() {
        super();
        this.channels = [
          { "id": "1db5aa62-5f8f-4fb8-8427-02ceda67cc45", "name": "What's For Din'?", "handle": "whatsfordin", "bannerImage": { "id": "448c17e4-fa59-42f5-9e27-a64fb0aa9614", "url": "https://channels.cc/448c17e4-fa59-42f5-9e27-a64fb0aa9614/BANNER1.jpg", "imageInfo": { "width": 2560, "height": 1440 } }, "owner": { "id": "24de4c67-771f-4f0f-8ffd-ca60bee4922b", "address": "D9HrZB95T1K5ODIIo2DJ+qGO8jU=", "handle": "whatsfordin", "publicKey": "-----BEGIN PUBLIC KEY-----\nMDYwEAYHKoZIzj0CAQYFK4EEAAoDIgADNpMVy09RwN63rDxjk2kq3iVAv6cHTixf\nNPUEvfMO0PU=\n-----END PUBLIC KEY-----", "name": "What's For Din'?", "image": { "id": "021ed124-46a9-4609-a4f0-cff41eb338bd", "url": "https://channels.cc/021ed124-46a9-4609-a4f0-cff41eb338bd/ThumbnailPic2crop.JPG", "imageInfo": { "width": 256, "height": 210 } } }, "created": 1517252720448, "about": "Delicious & Easy Recipes | Lifestyle | Health", "linkUrl": "www.youtube.com/whatsfordincourtneybudzyn", "socialLinks": [], "stats": { "subscribers": 12, "cards": 25, "revenue": 470.0313260626973 }, "subscriptionState": "subscribed" },
          { "id": "5862f46a-0c5a-4794-9b7a-8f6a0d418612", "name": "Clay Hayes", "handle": "clayhayes", "bannerImage": { "id": "d1101c1e-20d8-4e45-814a-003b4d84a1ae", "url": "https://channels.cc/d1101c1e-20d8-4e45-814a-003b4d84a1ae/YOUTUBE-BANNER.jpg", "imageInfo": { "width": 2560, "height": 1440 } }, "owner": { "id": "634333b3-b1ee-4a5f-ba8c-5b5ef642bebd", "address": "fIcJ3XrPqKJoJjpuJ9qtkQ40QsQ=", "handle": "clayhayes", "publicKey": "-----BEGIN PUBLIC KEY-----\nMDYwEAYHKoZIzj0CAQYFK4EEAAoDIgACJwjeXFCAXuQ3A7cTTwZ1yttRyVUcn5Hb\nm7z3TKbr6M0=\n-----END PUBLIC KEY-----", "name": "Clay Hayes", "image": { "id": "0289d676-39fc-4a2d-be80-0307383e77dd", "url": "https://channels.cc/0289d676-39fc-4a2d-be80-0307383e77dd/cougarAVATAR.jpg" } }, "created": 1517252714768, "about": "Traditional Archery, Bow Building, Bushcraft, Survival Skills, Bow Hunting", "linkUrl": "https://www.twistedstave.com", "socialLinks": [], "stats": { "subscribers": 6, "cards": 10, "revenue": 615.0673676177753 }, "subscriptionState": "subscribed" },
          { "id": "cc393c64-d8ab-4b72-b8db-66cfcb8c2e53", "name": "Thomas West", "handle": "tomwest", "bannerImage": { "id": "7eee57dd-ddc2-42c0-bc35-d55c720598ab", "url": "https://channels.cc/7eee57dd-ddc2-42c0-bc35-d55c720598ab/tom-banner-C.png", "imageInfo": { "width": 2560, "height": 1440 } }, "owner": { "id": "2aedc157-1960-4674-80b7-bb537d4e1e43", "address": "JMR9FzJyADseDIPhCx4Dsjai03c=", "handle": "tomwest", "publicKey": "-----BEGIN PUBLIC KEY-----\nMDYwEAYHKoZIzj0CAQYFK4EEAAoDIgADBtEzaTFAwaAKlyVXW11h5Z8GuEPd0NQw\nCuIENB6W0w8=\n-----END PUBLIC KEY-----", "name": "Thomas West", "image": { "id": "e4d0714f-c184-48d9-b38f-19e0906bfd65", "url": "https://channels.cc/e4d0714f-c184-48d9-b38f-19e0906bfd65/tom-on-boat.jpg", "imageInfo": { "width": 256, "height": 384 } } }, "created": 1517783815077, "about": "I'm going to make videos about stuff. And maybe some other stuff too... Cheers for having a look :)", "linkUrl": "", "socialLinks": [], "stats": { "subscribers": 7, "cards": 2, "revenue": 9.499999999999982 }, "subscriptionState": "subscribed" },
          { "id": "a68e3a94-7590-434d-b576-2bf65bc22d4d", "name": "Nicky Havey", "handle": "nickyhavey", "bannerImage": { "id": "5f53267f-081c-45ae-97a8-b719943670c8", "url": "https://channels.cc/5f53267f-081c-45ae-97a8-b719943670c8/CopyofLiquidDrumBass.png", "imageInfo": { "width": 2560, "height": 1440 } }, "owner": { "id": "15ea9a8c-cf6c-472a-91b9-0addaa229221", "address": "he0UQwwnK2hojIKxINGvEc5LJbA=", "handle": "nickyhavey", "publicKey": "-----BEGIN PUBLIC KEY-----\nMDYwEAYHKoZIzj0CAQYFK4EEAAoDIgADJtbHWalUBLvHzZYFojqF8yjWx3cH/REW\nSTilveqb/is=\n-----END PUBLIC KEY-----", "name": "Nick Harrison", "image": { "id": "157d9968-509d-4093-b4cb-8f1bb4e9af2e", "url": "https://channels.cc/157d9968-509d-4093-b4cb-8f1bb4e9af2e/FortheFBwankstains.jpg", "imageInfo": { "width": 256, "height": 230 } } }, "created": 1518206621077, "about": "I am a Liquid Drum & Bass producer from the UK, producing tracks with a trance element to them. I make these tracks to help me get through life events and every one has a story to tell. If they inspire you then let me know, I'm always happy to help where I can :)", "linkUrl": "www.nickyhavey.co.uk", "socialLinks": [], "stats": { "subscribers": 3, "cards": 3, "revenue": 0.15000000000000002 }, "subscriptionState": "unsubscribed" }
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        this._pollForTemplate();
      }

      _pollForTemplate() {
        const panels = this.shadowRoot.querySelectorAll(".panel");
        if (panels && (panels.length === this.channels.length)) {
          this.selected = 0;
        } else {
          setTimeout(() => {
            this._pollForTemplate();
          }, 100);
        }
      }

      getBg(item) {
        if (item.bannerImage && item.bannerImage.url) {
          return 'background-image: url("' + item.bannerImage.url + '");';
        }
        return "";
      }

      getChannelImage(item) {
        return (item.owner.image ? item.owner.image.url : null) || $core.userManager.getFallbackUserImage(item.owner.handle);
      }

      _onSelected() {
        let c = this.channels[this.selected];
        if (!c) {
          return;
        }
        const panels = this.shadowRoot.querySelectorAll(".panel");
        let activeP = null;
        for (let i = 0; i < panels.length; i++) {
          let p = panels[i];
          if (p.dataset.id == c.id) {
            p.classList.remove("hidden");
            p.classList.add("transparent");
            activeP = p;
          } else {
            p.classList.add("hidden");
          }
        }
        const cells = this.shadowRoot.querySelectorAll(".cell");
        for (let i = 0; i < cells.length; i++) {
          let p = cells[i];
          p.selected = (p.dataset.id == c.id);
        }

        setTimeout(() => {
          let ds = this.shadowRoot.querySelectorAll(".description");
          for (let i = 0; i < ds.length; i++) {
            ds[i].refresh();
          }
          setTimeout(() => {
            if (activeP) {
              activeP.classList.remove("transparent");
            }
          }, 400);
        }, 100);
      }

      _onCellClick(event) {
        this.selected = event.model.index;
      }
    }
    window.customElements.define(ChannelCarousel.is, ChannelCarousel);
  </script>
</dom-module>