<dom-module id="hash-router">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    class HashRouter extends Polymer.Element {
      constructor() {
        super();
        this._attached = false;
      }

      static get is() { return "hash-router"; }

      static get properties() {
        return {
          route: {
            type: Object,
            notify: true,
            observer: 'onRoute'
          },
          context: Object,
          animation: String,
          validator: Object
        };
      }

      onRoute() {
        this.dispatchEvent(new CustomEvent('route-change', { bubbles: true, composed: true, detail: { route: this.route } }));
      }

      connectedCallback() {
        super.connectedCallback();
        this.validator = null;
        if (this._attached) {
          return;
        }
        window.addEventListener("hashchange", (event) => {
          this._pendingUrl = event.newURL;
          this._oldUrl = event.oldURL;
          if (this.validator && this.validator.validateHashChange) {
            this.validator.validateHashChange(this._pendingUrl, this._oldUrl).then((proceed) => {
              if (proceed) {
                this.onHashChange();
              } else {
                if (history.replaceState) {
                  history.pushState(null, null, this._oldUrl);
                  // history.replaceState(null, null, this._oldUrl);
                } else {
                  this.onHashChange();
                }
              }
            }).catch(() => {
              this.onHashChange();
            });
          } else {
            this.onHashChange();
          }
        });
        this._attached = true;
        window.requestAnimationFrame(() => {
          this.onHashChange();
        });
      }

      goto(segments, context, animation) {
        if (segments) {
          if (!Array.isArray(segments)) {
            segments = [segments];
          }
        }
        let hash = "#";
        if (segments && segments.length) {
          hash += segments[0];
          for (let i = 1; i < segments.length; i++) {
            const seg = segments[i];
            if (seg) {
              hash += "/" + encodeURIComponent(seg);
            }
          }
        }
        this.context = context || null;
        this.animation = animation || null;
        window.location.assign(hash);
      }

      onHashChange() {
        let pathname = window.location.pathname;
        let hash = window.location.hash || "";
        let segments = [];
        if ((!hash) && pathname.indexOf('/c/') === 0) {
          let cardId = pathname.substring(3);
          segments = ["card", decodeURIComponent(cardId)];
        } else {
          if (hash) {
            hash = hash.substring(1);
          } else {
            hash = "";
          }
          segments = hash.split("/") || [];
          for (var i = 1; i < segments.length; i++) {
            segments[i] = decodeURIComponent(segments[i]);
          }
          if (pathname.indexOf('/c/') === 0) {
            window.location.replace('/app/#' + hash);
            return;
          }
        }
        this.set("route", {
          segments: segments,
          context: this.context,
          animation: this.animation
        });
      }
    }

    window.customElements.define(HashRouter.is, HashRouter);
  </script>
</dom-module>