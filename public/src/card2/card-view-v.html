<link rel="import" href="../../bower_components/soso-dropdown/soso-dropdown.html">
<link rel="import" href="../../bower_components/soso-tooltip/soso-tooltip.html">
<link rel="import" href="../controls/user-image.html">
<link rel="import" href="../controls/moment.html">
<link rel="import" href="../card/card-view-helper.html">

<dom-module id="card-view-v">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        position: relative;
        background: white;
      }

      .cardShell {
        position: relative;
        height: 100%;
        box-sizing: border-box;
      }

      .container {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        background: white;
        position: relative
      }

      #imagePanel {
        overflow: hidden;
        background-color: #fff;
        background-size: cover;
        background-origin: border-box;
        background-position: 50% 50%;
        border-radius: 3px 3px 0 0;
        position: relative;
      }

      #infoPanel {
        padding: 10px 14px;
        position: relative;
      }

      #headline {
        font-size: 18px;
        margin-bottom: 6px;
      }

      #headline img {
        float: left;
        margin: 0 8px 1px 0;
        height: 1.4em;
        opacity: 0.6;
        width: auto;
      }

      #description {
        font-size: 14px;
        color: #424242;
      }

      .bottomBar {
        border-radius: 0 0 3px 3px;
        font-size: 13px;
        padding: 0 0 0 10px;
        border-top: 1px solid #e5e5e5;
        color: #888888;
      }

      #revenue {
        color: var(--highlight-green);
        font-weight: bold;
        font-size: 14px;
        margin-right: 5px;
        cursor: default;
      }

      #privateIcon {
        margin: 0;
        width: 16px;
        height: 16px;
      }

      #upPanel,
      #downPanel {
        margin: 0 10px;
        cursor: pointer;
      }

      #upPanel soso-icon,
      #downPanel soso-icon {
        margin-right: 5px;
        color: #999;
      }

      #upPanel:hover,
      #downPanel:hover {
        color: var(--dark-green);
      }

      #upPanel:hover soso-icon,
      #downPanel:hover soso-icon {
        color: var(--highlight-green);
      }

      soso-icon {
        color: #888888;
        width: 18px;
        height: 18px;
      }

      soso-icon.actionIcon {
        width: 24px;
        height: 24px;
        padding: 10px 8px;
        cursor: pointer;
      }
    </style>
    <div class="cardShell">
      <div id="container" class="container vertical layout">
        <div id="imagePanel" class="flex"></div>
        <div id="contentPanel">
          <div id="infoPanel" class="vertical layout">
            <div id="headline">
              <img src$="[[data.cardType.iconUrl]]">
              <span>[[titleText]]</span>
            </div>
            <div id="description" class="flex">[[descriptionText]]</div>
          </div>
          <div class=""></div>
          <div class="horizontal layout center bottomBar">
            <div id="revenue">â„‚[[data.stats.revenueDisplay]]</div>
            <soso-icon id="privateIcon" icon="lock" icon-map="[[iconMap]]" class="hidden"></soso-icon>
            <div class="flex"></div>
            <div id="upPanel" class="horizontal layout center">
              <soso-icon icon="thumb-up"></soso-icon>
              <span>0</span>
            </div>
            <div id="downPanel" class="horizontal layout center">
              <soso-icon icon="thumb-down"></soso-icon>
              <span>0</span>
            </div>
            <soso-icon icon="share" class="actionIcon"></soso-icon>
            <soso-icon id="moreIcon" icon="expand-more" class="actionIcon hidden"></soso-icon>
          </div>
        </div>
      </div>
    </div>

    <soso-tooltip for="revenue" position="top" offset="10">
      <div style="min-width: 75px;">Total card revenue</div>
    </soso-tooltip>
  </template>
  <script>
    class CardViewV extends Polymer.Element {
      static get is() { return 'card-view-v'; }
      static get properties() {
        return {
          data: {
            type: Object,
            observer: "_onData"
          },
          descriptionText: String,
          titleText: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._attached = true;
        this._onData();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._attached = false;
      }

      _onData() {
        if (this._attached && this.data) {
          this.descriptionText = this._truncate(this.data.summary.text || "", 180);
          this.titleText = this._truncate(this.data.summary.title || "", 100);
          this._refreshRevenue();
        }
      }

      _refreshRevenue() {
        if (this.data.pricing.openFeeUnits > 0) {
          this.$.revenue.classList.remove("hidden");
        } else {
          this.$.revenue.classList.add("hidden");
        }
        this.set("data.stats.revenueDisplay", this.data.stats.revenue.toFixed(2));
      }

      _truncate(text, limit) {
        if ((!text) || (text.length <= limit)) {
          return text || "";
        }
        return (text.substring(0, limit - 3).trim() + "...");
      }
    }
    window.customElements.define(CardViewV.is, CardViewV);
  </script>
</dom-module>