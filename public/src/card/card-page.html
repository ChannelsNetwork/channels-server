<link rel="import" href="../../bower_components/soso-app-header/soso-app-header.html">
<link rel="import" href="../app/channels-bar.html">
<link rel="import" href="../../bower_components/soso-spinner/soso-spinner.html">
<link rel="import" href="open-card-header.html">
<link rel="import" href="../controls/user-image.html">

<dom-module id="card-page">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        position: relative;
        border-radius: 0 !important;
        box-shadow: none !important;
        background: white;
      }

      #header {
        opacity: 0;
        transition: opacity 0.25s ease;
      }

      #nocard {
        text-align: center;
        box-sizing: border-box;
        padding-bottom: 40px;
      }

      #loadingPanel {
        max-width: 800px;
        margin: 0 auto;
        padding: 10px;
        text-align: center;
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      soso-spinner {
        margin-top: 20px;
        margin-left: -10px;
      }

      #morePanel {
        padding: 30px 16px;
        border-top: 1px solid #e5e5e5;
        margin-top: 20px;
        box-sizing: border-box;
        text-align: center;
      }

      #morePanelContent {
        box-sizing: border-box;
        margin: 0 auto;
        display: block;
        max-width: 400px;
      }

      a,
      a:visited,
      a:hover {
        color: var(--dark-green);
        letter-spacing: initial;
      }

      .myvote {
        color: var(--highlight-green);
      }

      soso-icon {
        color: #808080;
        width: 28px;
        height: 28px;
        padding: 0 8px;
        cursor: pointer;
      }

      #ratingTip {
        padding-left: 10px;
        font-size: 13px;
      }

      #channelCardletPanel {
        padding-left: 22px;
        box-sizing: border-box;
        margin: 20px 0;
        transition: opacity 0.2s ease;
      }

      #channelCardlet {
        position: relative;
        padding: 10px 0;
        box-sizing: border-box;
        text-align: left;
        border-radius: 3px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        background-color: #fafafa;
        background-size: cover;
        background-origin: border-box;
        background-position: 50% 50%;
      }

      #channelCardlet .channelNameCell {
        padding-left: 28px;
        font-size: 16px;
        cursor: pointer;
      }

      #channelCardlet .channelName {
        background: rgba(250, 250, 250, 0.85);
        padding: 5px 10px;
        border-radius: 3px;
      }

      #channelCardlet button {
        font-size: 14px;
        padding: 10px 5px;
        letter-spacing: initial;
        font-weight: 400;
      }

      user-image {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #fafafa;
        position: absolute;
        top: 50%;
        left: -22px;
        cursor: pointer;
        margin-top: -22px;
      }

      @media (max-width: 600px) {
        #morePanel {
          padding: 30px 8px 30px 5px;
        }
        #morePanelContent {
          font-size: 14px;
        }
        #channelCardlet .channelNameCell {
          font-size: 15px;
        }
      }
    </style>
    <soso-app-header>
      <channels-bar id="cbar"></channels-bar>
      <open-card-header id="header" data="[[data]]" on-card-down-vote="_onDownVote" on-card-up-vote="_onUpVote" on-card-close="_closeCard"
        on-card-deleted="_closeCard" on-content-updated="_cardContendUpdated"></open-card-header>
    </soso-app-header>
    <div id="nocard" class="horizontal layout center hidden">
      <div style="width: 100%; box-sizing: border-box; padding: 16px;">
        <div style="margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.05em; color: #808080;">No card found</div>
        <div>
          <button on-click="_closeCard">back to channels feed</button>
        </div>
      </div>
    </div>
    <div id="hasCard">
      <div id="loadingPanel">
        <div>
          <soso-spinner id="spinner"></soso-spinner>
        </div>
        <p>Loading card</p>
      </div>
      <div id="cardView" class="hidden"></div>
      <div id="morePanel" class="hidden">
        <div id="morePanelContent">
          <div class="horizontal layout center" style="margin-bottom: 15px;">
            <div class="flex"></div>
            <div>
              <soso-icon id="upIcon" icon="thumb-up" icon-map="[[iconMap]]" on-click="_onUpVote"></soso-icon>
            </div>
            <div>
              <soso-icon id="downIcon" icon="thumb-down" icon-map="[[iconMap]]" on-click="_onDownVote"></soso-icon>
            </div>
            <div id="ratingTip">[[ratingTip]]</div>
            <div class="flex"></div>
          </div>
          <div id="channelCardletPanel">
            <div id="channelCardlet" class="horizontal layout center">
              <div class="flex channelNameCell" on-click="_gotoChannel">
                <span class="channelName">[[channel.name]]'s channel</span>
              </div>
              <div style="padding: 0 5px;">
                <button id="btnS" class="hidden" on-click="_onSubscribe">Subscribe</button>
                <button id="btnU" class="hidden" on-click="_onUnsubscribe">Unsubscribe</button>
              </div>
              <user-image image="[[channelImage]]" on-click="_gotoChannel"></user-image>
            </div>
          </div>
          <div>
            <a href="/feed">View your feed</a> to see recommended cards.</div>
        </div>
      </div>

    </div>
    <insufficient-funds-dialog id="insufficientFunds"></insufficient-funds-dialog>
  </template>
  <script>
    class CardPage extends Polymer.Element {
      static get is() { return 'card-page'; }
      static get properties() {
        return {
          data: Object,
          ratingTip: String,
          channelUrl: String,
          channel: Object,
          channelImage: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.iconMap = window._channelIcons;
      }

      onActivate(route) {
        this._active = true;
        this._route = route;
        this.data = null;
        this.paymentInterval = 10000;
        $core.register().then(() => {
          this.$.cbar.activate();
          if (route.segments.length < 2) {
            this._onNoCard();
          } else {
            this.cardId = route.segments[1].trim();
            if (!this.cardId) {
              this._onNoCard();
            } else {
              this._loadCard();
            }
          }
        }).catch((err) => {
          console.error(err);
          setTimeout(() => {
            $router.goto("");
          }, 600);
        });
        setTimeout(() => {
          this.$.header.style.opacity = 1;
        }, 1250);
      }

      onDeactivate() {
        this._active = false;
        this.$.cbar.deactivate();
        this._stopPaymentTimer();
        this._clearNode(this.$.cardView);
        this.$.header.style.opacity = 0;
        if (this._cardOpened && this.data) {
          $core.cardClosed(this.data.id);
        }
      }

      _onNoCard() {
        this.$.nocard.classList.remove("hidden");
        this.$.hasCard.classList.add("hidden");
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      _cardContendUpdated() {
        this._loadCard();
      }

      _gotoChannel() {
        $router.goto(this.channelUrl);
      }

      _loadCard() {
        this._cardOpened = false;
        this.$.nocard.classList.add("hidden");
        this.$.hasCard.classList.remove("hidden");
        this.$.morePanel.classList.add("hidden");
        this._clearNode(this.$.cardView);

        // show loading spinner
        this.$.cardView.classList.add("hidden");
        this.$.header.classList.add("disabled");
        this.$.spinner.spinning = true;
        this.$.loadingPanel.classList.remove("hidden");

        // Fetch the card and then encure card package
        // Then import the viewer and then insert the viewer
        $core.getCard(this.cardId).then((cardData) => {
          // set card data
          // If card was opened from a pomoted card, override that flag
          if (this._route.context) {
            let card = this._route.context.card;
            if (card) {
              cardData.card.promoted = card.promoted;
            }
          }
          this.data = cardData.card;
          this.channelUrl = "/channel/" + encodeURIComponent(this.data.by.handle);
          this._refreshRating();
          this.paymentInterval = cardData.paymentDelayMsecs || 10000;

          this.$.channelCardletPanel.style.opacity = 0;
          setTimeout(() => {
            this._loadChannel();
          });

          if ($core.balance < this.data.pricing.openFee && this.data.userSpecific.paidToAuthor === 0) {
            this._import("../dialogs/insufficient-funds-dialog.html").then(() => {
              return this.$.insufficientFunds.show().then((result) => {
                if (result && result.page && result.page === "balance") {
                  $router.goto("/balance");
                } else {
                  this._doCardClose(this.data.id);
                }
              });
            });
          } else {
            // Import card package
            let packageName = this.data.cardType.package;
            if (!packageName) {
              console.error("Failed to load card - inavlid package name");
              this._onNoCard();
              return;
            }
            return $core.cardManager.ensurePackage(packageName).then((packageInfo) => {
              // Import the card viewer
              return this._import(packageInfo.importHref).then(() => {
                this._createCardView(packageInfo);
                setTimeout(() => {
                  if (this._active) {
                    this._startPaymentTimer();
                    $core.cardOpened(this.data.id);
                    this._cardOpened = true;
                  }
                });
              });
            });
          }
        }).catch((err) => {
          console.error(err);
          this._onNoCard();
        });
      }

      _loadChannel() {
        if (this._active && this.data) {
          return $core.getChannelByOwnerHandle(this.data.by.handle).then(response => {
            if (!this._active) {
              return;
            }
            this.channel = response.channel;
            this.channelImage = (this.channel.owner.image ? this.channel.owner.image.url : null) || $core.userManager.getFallbackUserImage(this.channel.owner.handle);
            let bgImage = "";
            if (this.channel.bannerImage) {
              bgImage = this.channel.bannerImage.url;
            }
            this.$.channelCardlet.style.backgroundImage = bgImage ? ('url("' + bgImage + '"') : "";
            this.$.channelCardletPanel.style.opacity = 1;
            this._refreshSubscribeButton();
          });
        }
      }

      _refreshSubscribeButton() {
        this.$.btnU.classList.add("hidden");
        this.$.btnS.classList.add("hidden");
        if (this.channel) {
          let isMe = false;
          if ($core.profile) {
            isMe = $core.profile.handle == this.channel.owner.handle;
          }
          if (!isMe) {
            switch (this.channel.subscriptionState) {
              case "subscribed":
                this.$.btnU.classList.remove("hidden");
                break;
              case "unsubscribed":
                this.$.btnS.classList.remove("hidden");
                break;
              default:
                break;
            }
          }
        }
      }

      _onSubscribe() {
        if (!this.channel) {
          return;
        }
        let channelUrl = "/channel/" + encodeURIComponent(this.data.by.handle);
        if (!$core.profile || !$core.profile.handle) {
          $router.goto("/register", { message: "Before you subscribe to this channel, you must first register an identity.", returnRoute: { success: channelUrl, cancel: channelUrl } });
          return;
        }
        $core.updateChannelSubscription(this.channel.id, 'subscribed').then(() => {
          this.channel.subscriptionState = "subscribed";
          this._refreshSubscribeButton();
        }).catch((err) => {
          console.error(err);
          $app.showError(err);
        });
      }

      _onUnsubscribe() {
        if (!this.channel) {
          return;
        }
        $core.updateChannelSubscription(this.channel.id, 'unsubscribed').then(() => {
          this.channel.subscriptionState = "unsubscribed";
          this._refreshSubscribeButton();
        }).catch((err) => {
          console.error(err);
          $app.showError(err);
        });
      }

      _refreshRating() {
        let uc = this.data.stats.likes;
        let dc = this.data.stats.dislikes;
        let tc = uc + dc;
        let rating = tc ? (uc / tc) * 100 : 0;
        this.$.downIcon.classList.remove("myvote");
        this.$.upIcon.classList.remove("myvote");
        const likeState = this.data.userSpecific.likeState || "none";
        if (likeState === "like") {
          this.$.upIcon.classList.add("myvote");
        } else if (likeState === "dislike") {
          this.$.downIcon.classList.add("myvote");
        }

        if (!tc) {
          this.ratingTip = "No votes";
        } else if (uc && (!dc)) {
          if (uc === 1) {
            this.ratingTip = "1 like";
          } else {
            this.ratingTip = uc + " likes";
          }
        } else if (dc && (!uc)) {
          if (dc === 1) {
            this.ratingTip = "1 dislike";
          } else {
            this.ratingTip = dc = " dislikes";
          }
        } else {
          let tip = "";
          if (uc === 1) {
            tip = "1 like and ";
          } else {
            tip = uc + " likes and ";
          }
          if (dc === 1) {
            tip += "1 dislike";
          } else {
            tip += dc + " dislikes";
          }
          this.ratingTip = tip;
        }
      }

      _import(url) {
        return new Promise((resolve, reject) => {
          Polymer.importHref(this.resolveUrl(url), () => {
            resolve();
          }, (err) => {
            reject(err);
          });
        });
      }

      _createCardView(packageInfo) {
        // hide loading spinner
        this.$.cardView.classList.remove("hidden");
        this.$.header.classList.remove("disabled");
        this.$.spinner.spinning = false;
        this.$.loadingPanel.classList.add("hidden");

        // create and insert viewer
        let cardNode = document.createElement(packageInfo.channelComponent.viewerTag);
        cardNode.cardSummary = this.data.summary;
        cardNode.sharedState = this.data.state.shared;
        cardNode.userState = this.data.state.user;
        cardNode.author = this.data.by;
        cardNode.user = $core.profile;
        cardNode.services = $core.cardManager.cardService;
        this.$.cardView.appendChild(cardNode);

        this.$.morePanel.classList.remove("hidden");
      }

      _stopPaymentTimer() {
        if (this._paymentTimer) {
          clearTimeout(this._paymentTimer);
          this._paymentTimer = null;
          let duration = (new Date()).getTime() - this._paymentTimerStart + (this._prevOpenDuration || 0);
          $core.cardManager.cacheCardData(this.cardId, "prev-operation-duration", duration);
        }
        this.$.header.hideTimer();
      }

      _startPaymentTimer() {
        if (this._paymentTimer) {
          return;
        }
        let startTimer = false;
        if (!this.data.userSpecific.isPoster) {
          if ((this.data.pricing.openFee > 0 && this.data.userSpecific.paidToAuthor === 0) ||
            (this.data.pricing.openFee < 0 && this.data.promoted && this.data.userSpecific.earnedFromAuthor == 0)) {
            startTimer = true;
          }
        }
        if (!startTimer) {
          return;
        }

        this._prevOpenDuration = $core.cardManager.getCachedCardData(this.cardId, "prev-operation-duration") || 0;
        if (this._prevOpenDuration >= this.paymentInterval) {
          this._onPaymentDue();
        } else {
          this._paymentTimerStart = (new Date()).getTime();
          this._paymentTimerInterval = this.paymentInterval - this._prevOpenDuration;
          this._paymentTimer = setInterval(() => {
            if (this._active) {
              let now = (new Date()).getTime();
              if ((now - this._paymentTimerStart) >= this._paymentTimerInterval) {
                this._onPaymentDue();
              } else {
                let value = (((now - this._paymentTimerStart) + this._prevOpenDuration) / this.paymentInterval) * 100;
                this.$.header.showTimer(value);
              }
            }
          }, 100);
        }
      }

      _onPaymentDue() {
        if (this._paymentTimer) {
          clearInterval(this._paymentTimer);
          this._paymentTimer = null;
        }
        $core.cardManager.removeCachedCardData(this.cardId, "prev-operation-duration");
        this.$.header.hideTimer();

        // make payment
        const card = this.data;
        if (!card.userSpecific.isPoster) {
          if (card.pricing.openFee > 0 && card.userSpecific.paidToAuthor === 0) {
            card.userSpecific.paidToAuthor = card.pricing.openFee;
            $core.cardPay(card.id, card.pricing.openFee, card.by.address, card.cardType.royaltyAddress, card.cardType.royaltyFraction, card.referredBy ? card.referredBy.address : null).then((response) => {
              card.stats.revenue = response.totalCardRevenue;
              $core.analytics.event("card", "paid");
              this._onPaymentSuccess();
            }).catch((err) => {
              console.error("Failed to make card payment", err);
            });
          } else if (card.pricing.openFee < 0 && card.promoted && card.userSpecific.earnedFromAuthor === 0 && card.couponId) {
            card.userSpecific.earnedFromAuthor = -card.pricing.openFee;
            $core.cardOpenPaymentRedeem(card.id, card.couponId, -card.pricing.openFee, card.by.address).then(() => {
              this._onPaymentSuccess();
            }).catch((err) => {
              console.error("Failed to make card payment", err);
            });
          }
        }
      }

      _onPaymentSuccess() {
        this.$.header.onPayment();
        this._fireUpdateCardData();
      }

      _closeCard() {
        this._doCardClose(null);
      }

      _fireUpdateCardData() {
        if (this.data) {
          window.dispatchEvent(new CustomEvent('card-data-updated', { bubbles: true, composed: true, detail: { card: this.data } }));
        }
      }

      _doCardClose(cardId) {
        if (this._route && this._route.context) {
          let context = this._route.context;
          let retContext = {
            scrollTop: this._route.context.scrollTop || 0
          };
          if (context.returnPath) {
            $router.goto(context.returnPath, retContext);
            return;
          }
        }
        $router.goto("");
      }

      _onUpVote() {
        if (!this.data) {
          return;
        }
        let likeState = this.data.userSpecific.likeState || "none";
        let newState = "like"
        if (likeState === "like") {
          newState = "none";
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) - 1);
          this.data.userSpecific.likeState = "none";
        } else if (likeState === "dislike") {
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) + 1);
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) - 1);
          this.data.userSpecific.likeState = "like";
        } else {
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) + 1);
          this.data.userSpecific.likeState = "like";
        }
        $core.updateCardLike(this.data.id, newState).catch((err) => {
          console.error("Failed to update like state", err);
        });
        this._refreshRating();
        this.$.header.refreshRating();
        window.dispatchEvent(new CustomEvent('card-data-updated', { bubbles: true, composed: true, detail: { card: this.data } }));
      }

      _onDownVote() {
        let likeState = this.data.userSpecific.likeState || "none";
        let newState = "dislike"
        if (likeState === "dislike") {
          newState = "none";
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) - 1);
          this.data.userSpecific.likeState = "none";
        } else if (likeState === "like") {
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) + 1);
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) - 1);
          this.data.userSpecific.likeState = "dislike";
        } else {
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) + 1);
          this.data.userSpecific.likeState = "dislike";
        }
        $core.updateCardLike(this.data.id, newState).catch((err) => {
          console.error("Failed to update like state", err);
        });
        this._refreshRating();
        this.$.header.refreshRating();
        window.dispatchEvent(new CustomEvent('card-data-updated', { bubbles: true, composed: true, detail: { card: this.data } }));
      }
    }
    window.customElements.define(CardPage.is, CardPage);
  </script>
</dom-module>