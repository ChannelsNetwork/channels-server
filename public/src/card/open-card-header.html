<link rel="import" href="../../bower_components/soso-dropdown/soso-dropdown.html">
<link rel="import" href="../../bower_components/soso-tooltip/soso-tooltip.html">
<link rel="import" href="../../bower_components/soso-dropdown/soso-dropdown.html">
<link rel="import" href="../controls/progress-icon.html">
<link rel="import" href="../controls/user-image.html">
<link rel="import" href="../controls/moment.html">

<dom-module id="open-card-header">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      .bar {
        background: #fafafa;
        font-size: 14px;
        height: 60px;
        border-radius: 3px 3px 0 0;
      }

      #pricePanel {
        padding: 0 8px;
        background: var(--bg-yellow);
        color: #000;
        letter-spacing: 0.05em;
        font-size: 15px;
        height: 100%;
        box-sizing: border-box;
        position: relative;
        width: 66px;
      }

      #pricePanel .pays {
        display: none;
      }

      #pricePanel.negative {
        background: #69F0AE;
      }

      #pricePanel.negative .pays {
        text-transform: uppercase;
        font-size: 11px;
        line-height: 14px;
        height: 14px;
        letter-spacing: 0.2em;
        color: rgba(0, 0, 0, 0.8);
        display: block;
        text-align: center;
        padding: 3px 6px;
      }

      #pricePanel #paidCheck {
        display: none;
      }

      #pricePanel.paid #paidCheck {
        height: 15px;
        width: 15px;
        color: var(--dark-green);
        display: block;
        margin: 0 auto 2px;
        cursor: initial;
      }

      #timestamp {
        font-size: 11px;
      }

      soso-icon {
        color: #808080;
        width: 28px;
        height: 28px;
        padding: 0 8px;
        cursor: pointer;
      }

      #authorImage {
        width: 40px;
        height: 40px;
        margin: 0 10px;
      }

      #payTimerProgress {
        position: absolute;
        top: 0;
        left: 3px;
        --soso-progress-negative-color: rgba(0, 0, 0, 0.1);
        --soso-progress-positive-color: var(--highlight-green);
      }

      #ratingIcon {
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -14px;
        margin-left: -22px;
        pointer-events: none;
      }

      .novotes {
        --soso-progress-negative-color: rgba(0, 0, 0, 0.1);
      }

      #likeDropdown {
        --soso-item-hover-color: transparent;
        text-align: center;
        font-size: 10pt;
        color: #555;
        letter-spacing: 0.05em;
      }

      .myvote {
        color: var(--highlight-green);
      }

      @media (max-width: 600px) {
        soso-icon {
          padding: 0 6px 0 4px;
        }
        #ratingIcon {
          margin-left: -19px;
        }
      }
    </style>
    <div class="horizontal layout center bar">
      <div id="pricePanel" class="horizontal layout center">
        <div class="flex" style="text-align: center;">
          <label class="pays">Pays</label>[[price]]
          <soso-icon id="paidCheck" icon="check-circle" icon-map="[[iconMap]]"></soso-icon>
        </div>
        <progress-icon id="payTimerProgress" class="hidden"></progress-icon>
      </div>
      <user-image id="authorImage"></user-image>
      <div class="flex vertical layout">
        <div>[[data.by.name]]</div>
        <div id="timestamp">[[data.postedAtDisplay]]</div>
      </div>
      <div style="position: relative;">
        <soso-icon id="ratingIcon" icon="thumbs-up-down" icon-map="[[iconMap]]"></soso-icon>
        <progress-icon id="likeRating" class="novotes"></progress-icon>
      </div>
      <soso-icon id="moreIcon" icon="expand-more" icon-map="[[iconMap]]" class="hidden"></soso-icon>
      <soso-icon icon="close" icon-map="[[iconMap]]" on-click="_onCloseCard"></soso-icon>

      <soso-dropdown for="moreIcon" alignment="right" offset="0">
        <li id="liPrivate" on-click="_makePrivate" class="hidden">Make private</li>
        <li id="liPublic" on-click="_makePublic" class="hidden">Make public</li>
        <li on-click="_deleteCard">Delete</li>
      </soso-dropdown>

      <soso-dropdown id="likeDropdown" for="likeRating" offset="0">
        <li>Your Vote</li>
        <li class="horizontal layout center">
          <div style="padding: 0 5px;">
            <soso-icon id="downIcon" icon="thumb-down" icon-map="[[iconMap]]" on-click="_onDownVote"></soso-icon>
          </div>
          <div style="padding: 0 5px;">
            <soso-icon id="upIcon" icon="thumb-up" icon-map="[[iconMap]]" on-click="_onUpVote"></soso-icon>
          </div>
        </li>
      </soso-dropdown>

      <soso-tooltip for="likeRating" position="left" offset="10">[[ratingTip]]</soso-tooltip>
    </div>
  </template>
  <script>
    class OpenCardHeader extends Polymer.Element {
      static get is() { return 'open-card-header'; }
      static get properties() {
        return {
          data: {
            type: Object,
            observer: '_refresh'
          },
          iconMap: Object,
          ratingTip: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.iconMap = window._channelIcons;
        this._refresh();
      }

      _refresh() {
        if (!this.data) {
          return;
        }
        this.$.authorImage.image = this.data.by.imageUrl || $core.userManager.getFallbackUserImage(this.data.by.handle);
        if (!this.data.postedAtDisplay) {
          this.set("data.postedAtDisplay", displayFriendlyTime(this.data.postedAt));
        }
        this._refreshPrice();
        this._refreshRating();
        this._refreshMore();
        this._refreshMenu();
      }

      _refreshPrice() {
        this._refreshPaidCheck();
        let cost = this.data.pricing.openFee;
        let absCost = Math.abs(cost).toFixed(2);
        this.price = 'â„‚' + absCost;
        if (cost <= 0) {
          this.$.pricePanel.classList.add("negative");
        } else {
          this.$.pricePanel.classList.remove("negative");
        }
        // check if the price needs to be shown
        let hidePrice = (cost === 0) || (cost < 0 && (!this.data.promoted));
        if (hidePrice && this._cardConsumed && cost) {
          hidePrice = false;
        }
        if (hidePrice) {
          this.$.pricePanel.classList.add("hidden");
        } else {
          this.$.pricePanel.classList.remove("hidden");
        }
      }

      _refreshRating() {
        let uc = this.data.stats.likes;
        let dc = this.data.stats.dislikes;
        let tc = uc + dc;
        let rating = tc ? (uc / tc) * 100 : 0;
        this.$.likeRating.value = rating;
        if (tc) {
          this.$.likeRating.classList.remove("novotes");
        } else {
          this.$.likeRating.classList.add("novotes");
        }
        this.$.downIcon.classList.remove("myvote");
        this.$.upIcon.classList.remove("myvote");
        const likeState = this.data.userSpecific.likeState || "none";
        if (likeState === "like") {
          this.$.upIcon.classList.add("myvote");
        } else if (likeState === "dislike") {
          this.$.downIcon.classList.add("myvote");
        }

        if (!tc) {
          this.ratingTip = "No votes";
        } else if (uc && (!dc)) {
          if (uc === 1) {
            this.ratingTip = "1 like";
          } else {
            this.ratingTip = uc + " likes";
          }
        } else if (dc && (!uc)) {
          if (dc === 1) {
            this.ratingTip = "1 dislike";
          } else {
            this.ratingTip = dc = " dislikes";
          }
        } else {
          let tip = "";
          if (uc === 1) {
            tip = "1 like and ";
          } else {
            tip = uc + " likes and ";
          }
          if (dc === 1) {
            tip += "1 dislike";
          } else {
            tip += dc + " dislikes";
          }
          this.ratingTip = tip;
        }
      }

      _refreshMore() {
        let owner = this.data && (this.data.by.address === $core.address);
        if (owner) {
          this.$.moreIcon.classList.remove("hidden");
        } else {
          this.$.moreIcon.classList.add("hidden");
        }
      }

      _refreshMenu() {
        if (this.data && this.data.private) {
          this.$.liPrivate.classList.add("hidden");
          this.$.liPublic.classList.remove("hidden");
        } else {
          this.$.liPrivate.classList.remove("hidden");
          this.$.liPublic.classList.add("hidden");
        }
      }

      _refreshPaidCheck() {
        let showCheck = (!this.data.userSpecific.isPoster) &&
          ((this.data.pricing.openFee > 0 && this.data.userSpecific.paidToAuthor) || (this.data.pricing.openFee < 0 && this.data.userSpecific.earnedFromAuthor));
        if (showCheck) {
          this.$.pricePanel.classList.add("paid");
        } else {
          this.$.pricePanel.classList.remove("paid");
        }
        this._cardConsumed = showCheck;
      }

      _onCloseCard(event) {
        this.dispatchEvent(new CustomEvent('card-close', { bubbles: true, composed: true }));
      }

      showTimer(value) {
        if (!this._timerVisible) {
          this._timerVisible = true;
          this.$.payTimerProgress.classList.remove("hidden");
          this.$.pricePanel.style.fontSize = "11px";
        }
        this.$.payTimerProgress.value = Math.max(0, Math.min(value, 100));
      }

      hideTimer() {
        if (this._timerVisible) {
          this._timerVisible = false;
          this.$.payTimerProgress.classList.add("hidden");
          this.$.pricePanel.style.fontSize = "";
        }
      }

      onPayment() {
        this._refreshPaidCheck();
      }

      _makePrivate() {
        this._updatePrivate(true);
      }

      _makePublic() {
        this._updatePrivate(false);
      }

      _updatePrivate(isPrivate) {
        if (this.data) {
          $core.updateCardPrivate(this.data.id, isPrivate).then((response) => {
            this.data.private = response.newValue;
            this._refreshMenu();
          }).catch((err) => {
            console.error("Failed to updated private flag", err);
          });
        }
      }

      _deleteCard() {
        $app.confirm("This will delete this card permanently.  Are you sure?", null, "Delete").then((result) => {
          if (result) {
            this._onCloseCard();
            requestAnimationFrame(() => {
              $core.deleteCard(this.data.id).then((response) => {
                this.dispatchEvent(new CustomEvent('card-deleted', { bubbles: true, composed: true, detail: { card: this.data } }));
              }).catch((err) => {
                console.error("Failed to delete card", err);
              });
            });
          }
        });
      }

      _onDownVote() {
        let likeState = this.data.userSpecific.likeState || "none";
        let newState = "dislike"
        if (likeState === "dislike") {
          newState == "none";
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) - 1);
          this.data.userSpecific.likeState = "none";
        } else if (likeState === "like") {
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) + 1);
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) - 1);
          this.data.userSpecific.likeState = "dislike";
        } else {
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) + 1);
          this.data.userSpecific.likeState = "dislike";
        }
        $core.updateCardLike(this.data.id, newState).catch((err) => {
          console.error("Failed to update like state", err);
        });
        this._refreshRating();
      }

      _onUpVote() {
        let likeState = this.data.userSpecific.likeState || "none";
        let newState = "like"
        if (likeState === "like") {
          newState == "none";
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) - 1);
          this.data.userSpecific.likeState = "none";
        } else if (likeState === "dislike") {
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) + 1);
          this.data.stats.dislikes = Math.max(0, (this.data.stats.dislikes || 0) - 1);
          this.data.userSpecific.likeState = "like";
        } else {
          this.data.stats.likes = Math.max(0, (this.data.stats.likes || 0) + 1);
          this.data.userSpecific.likeState = "like";
        }
        $core.updateCardLike(this.data.id, newState).catch((err) => {
          console.error("Failed to update like state", err);
        });
        this._refreshRating();
      }
    }
    window.customElements.define(OpenCardHeader.is, OpenCardHeader);
  </script>
</dom-module>