<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../bower_components/soso-number-input/soso-number-input.html">
<link rel="import" href="../../../bower_components/soso-radio-group/soso-radio-group.html">
<link rel="import" href="../../../bower_components/soso-radio-button/soso-radio-button.html">
<link rel="import" href="../../../bower_components/soso-checkbox/soso-checkbox.html">
<link rel="import" href="../../../bower_components/soso-collapsible-panel/soso-collapsible-panel.html">
<link rel="import" href="../../../bower_components/soso-text-input/soso-text-input.html">
<link rel="import" href="../../controls/filter-selector.html">

<dom-module id="card-budget-view">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #container {
        background: #fcfcfc;
        min-height: 100vh;
        margin-top: -50px;
      }

      #progress {
        padding: 70px 10px 20px;
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
      }

      #main {
        padding: 70px 10px 20px;
        max-width: 600px;
        margin: 0 auto;
      }

      h2 {
        margin-bottom: 25px;
      }

      label {
        display: block;
        font-size: 16px;
        letter-spacing: 0.05em;
        color: var(--dark-green);
        font-weight: bold;
        margin-bottom: 10px;
        text-transform: uppercase;
      }

      .cost {
        background: var(--bg-yellow);
        display: inline-block;
        font-size: 16px;
        padding: 3px 6px;
        border-radius: 3px;
        letter-spacing: 0.03em;
        color: #000;
      }

      section {
        padding-bottom: 30px;
      }

      .row {
        padding-top: 5px;
      }

      input[type="date"] {
        outline: none;
        font-family: inherit;
        font-size: 16px;
        padding: 5px 2px;
        border: none;
        color: inherit;
        background: transparent;
        border-bottom: 2px solid #4CAF50;
      }

      input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 1;
        color: var(--dark-green);
      }

      input[type="date"]::-webkit-clear-button,
      input[type="date"]::-webkit-inner-spin-button,
      input[type="date"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        display: none;
      }

      soso-checkbox {
        font-size: 14px;
        margin: 3px 0 0;
        display: inline-block;
        width: 144px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .slidePanelContent {
        padding: 20px 0;
      }

      @media (max-width: 600px) {
        h2 {
          display: none;
        }
      }
    </style>
    <div id="container">
      <div id="main">
        <h2>Card Promotion Budget</h2>

        <section>
          <label>Promotion Cost</label>
          <div id="payToOpenImpressPanel">
            You will pay the reader
            <span class="cost">ℂ0.01</span> to see this card in their feed.
          </div>
          <div id="impressionPanel" class="hidden">
            You will pay the reader
            <span class="cost">ℂ0.01</span> to see this card in their feed.
          </div>
          <div id="payToOpenPanel" class="hidden">
            You will pay the reader
            <span class="cost">ℂ0.01</span> to see this card in their feed.
          </div>
        </section>

        <section id="dailySection">
          <label>Daily Budget</label>
          <div class="row">
            ℂ
            <soso-number-input id="dailyBudget" value="5" step="1" min="0"></soso-number-input>
          </div>
        </section>

        <section>
          <label>End Date</label>
          <div>This promotion campaign will run until:</div>
          <div class="row">
            <input id="endDate" type="date">
          </div>
        </section>

        <section>
          <label>Region</label>
          <div>Select if you'd like to focus the promotion campaign to a specific region</div>
          <div class="row">
            <soso-radio-group id="regionGroup" on-select="_onRegionSelectionChange">
              <soso-radio-button name="none" label="All regions"></soso-radio-button>
              <soso-radio-button name="conutries" label="Selected countries"></soso-radio-button>
              <soso-radio-button name="region" label="Selected regions in a specific country"></soso-radio-button>
            </soso-radio-group>
          </div>
        </section>

        <section id="countriesSection" class="hidden">
          <label>Select Countries</label>
          <template is="dom-repeat" items="[[continents]]">
            <soso-collapsible-panel label="[[item.name]]" collapsed>
              <div class="slidePanelContent">
                <template is="dom-repeat" items="[[item.countries]]" as="country">
                  <soso-checkbox class="countryCheck" data-continent$="[[item.code]]" data-code$="[[country.code]]" label="[[country.name]]"
                    title="[[country.name]]" on-change="_onCountryChange"></soso-checkbox>
                </template>
                <soso-checkbox data-all-code$="[[item.code]]" class="allContinentCheck" label="All" on-change="_onAll"></soso-checkbox>
              </div>
            </soso-collapsible-panel>
          </template>
        </section>

        <section id="regionsSection" class="hidden">
          <label>Select a Country</label>
          <filter-selector id="countrySelector" data="[[countries]]" fields="[[countryFields]]" on-select="_countrySelected"></filter-selector>

          <section id="regionTypeSection" class="hidden">
            <div>Select if you'd like to pick the regions or enter postal codes</div>
            <div class="row">
              <soso-radio-group id="regionTypeGroup" on-select="_regionTypeSlectionChange">
                <soso-radio-button name="region" label="Selected regions"></soso-radio-button>
                <soso-radio-button name="zip" label="Postal codes"></soso-radio-button>
              </soso-radio-group>
            </div>
          </section>

          <section id="countryRegionSection" class="hidden">
            <template is="dom-repeat" items="[[regions]]">
              <soso-checkbox class="regionsCheck" label="[[item.name]]" title="[[item.name]]" on-change="_regionChange"></soso-checkbox>
            </template>
            <soso-checkbox id="chkAllRegions" label="All" on-change="_onAllRegions"></soso-checkbox>
          </section>

          <section id="countryZipSection" class="hidden">
            <label class="row">Postal codes</label>
            <div>Enter comma separated postal codes (zip codes)</div>
            <soso-text-input id="zipCodes" label="" placeholder="Postal codes" class="row"></soso-text-input>
          </section>


        </section>
      </div>
    </div>
  </template>
  <script>
    class CardBudgetView extends Polymer.Element {
      static get is() { return 'card-budget-view'; }
      static get properties() {
        return {
          continents: Object,
          countries: Array,
          regions: Array,
          data: {
            type: Object,
            observer: '_refresh'
          },
          countryFields: {
            type: Array,
            value: () => { return ['code', 'name']; }
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._refresh();
      }

      _refresh() {
        if (this.data) {
          this.$.regionGroup.selected = "none";
          this._onRegionSelectionChange();
        }
      }

      _onRegionSelectionChange() {
        switch (this.$.regionGroup.selected) {
          case "none":
            this.$.countriesSection.classList.add("hidden");
            this.$.regionsSection.classList.add("hidden");
            break;
          case "conutries":
            this._fetchAllCountries();
            this.$.countriesSection.classList.remove("hidden");
            this.$.regionsSection.classList.add("hidden");
            break;
          case "region":
            this._fetchAllCountries();
            this.$.countriesSection.classList.add("hidden");
            this.$.regionsSection.classList.remove("hidden");
            break;
        }
      }

      _fetchAllCountries() {
        if (this.continents && this.continents.length) {
          return;
        }
        $core.getGeoDescriptors().then(result => {
          let countries = [];
          for (let cont of result.continents) {
            let cByC = result.countriesByContinent[cont.code];
            for (let c of cByC) {
              c.selected = false;
            }
            countries = countries.concat(cByC);
            cont.countries = cByC;
          }
          this.continents = result.continents;
          countries.sort((a, b) => {
            let an = a.name.toLowerCase();
            let bn = b.name.toLowerCase();
            if (an < bn) return -1;
            if (an > bn) return 1;
            return 0;
          });
          this.countries = countries;
        });
      }

      _onAll(event) {
        let all = event.target;
        let continent = all.dataset.allCode;
        let checked = all.checked;
        const boxes = this.shadowRoot.querySelectorAll(".countryCheck");
        for (let i = 0; i < boxes.length; i++) {
          let b = boxes[i];
          if (b.dataset.continent === continent) {
            b.checked = checked;
          }
        }
      }

      _onCountryChange(event) {
        let chk = event.target;
        if (!chk.checked) {
          const boxes = this.shadowRoot.querySelectorAll(".allContinentCheck");
          for (let i = 0; i < boxes.length; i++) {
            let b = boxes[i];
            if (b.dataset.allCode === chk.dataset.continent) {
              b.checked = false;
              break;
            }
          }
        }
      }

      _countrySelected(event) {
        let selected = event.detail.selection;
        this.$.zipCodes.value = "";
        if (selected) {
          $core.getGeoDescriptors(selected.code).then((result) => {
            let regions = result && result.regionsByCountry && result.regionsByCountry[selected.code];
            if (regions && regions.length) {
              this.$.regionTypeSection.classList.remove("hidden");
              this.$.regionTypeGroup.selected = null;
            } else {
              this.$.regionTypeGroup.selected = "zip";
              this.$.regionTypeSection.classList.add("hidden");
              this.$.countryRegionSection.classList.add("hidden");
              this.$.countryZipSection.classList.remove("hidden");
            }
          });
        } else {
          this.$.regionTypeSection.classList.add("hidden");
          this.$.countryZipSection.classList.add("hidden");
          this.$.countryRegionSection.classList.add("hidden");
        }
      }

      _regionTypeSlectionChange() {
        if (this.$.regionTypeGroup.selected === 'zip') {
          this.$.countryRegionSection.classList.add("hidden");
          this.$.countryZipSection.classList.remove("hidden");
        } else {
          this.$.countryRegionSection.classList.remove("hidden");
          this.$.countryZipSection.classList.add("hidden");
        }
      }
    }
    window.customElements.define(CardBudgetView.is, CardBudgetView);
  </script>
</dom-module>