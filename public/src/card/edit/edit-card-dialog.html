<link rel="import" href="../../controls/dialog-view.html">
<link rel="import" href="../../controls/image-upload.html">
<link rel="import" href="../../../bower_components/soso-text-input/soso-text-input.html">
<link rel="import" href="../../../bower_components/soso-checkbox/soso-checkbox.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="edit-card-dialog">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #filePicker {
        margin: 20px 0 12px;
        height: 160px;
      }

      soso-text-input {
        margin: 18px 0;
      }

      #private {
        margin-top: 25px;
        color: #555;
      }

      #clearImage {
        position: absolute;
        top: 5px;
        right: 5px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.8);
        color: #555;
        z-index: 1;
        border-radius: 50%;
        padding: 5px;
        border: 2px solid #555;
        width: 18px;
        height: 18px;
      }

      .languageSelection {
        margin: 25px 0;
      }

      .languageLabel {
        color: var(--dark-green);
        margin-right: 10px;
      }

      #languageSelect {
        font-size: 16px;
        font-family: inherit;
        font-weight: inherit;
        outline: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border: 0;
        padding: 5px 3px;
        border: none;
        border-radius: 0;
        background: none;
        border-bottom: 1px solid;
        letter-spacing: 0.03em;
        color: inherit;
      }
    </style>
    <dialog-view id="dlg" buttons="[[_buttons]]" on-button-click="_handleButton">
      <h3>Edit Card</h3>
      <div style="position: relative;">
        <image-upload id="filePicker" on-image-set="_onImageSet"></image-upload>
        <soso-icon class="hidden" id="clearImage" icon="close" icon-map="[[iconMap]]" on-click="_clearImage"></soso-icon>
      </div>
      <soso-text-input id="title" label="Title" placeholder="Title"></soso-text-input>
      <soso-text-input id="text" label="Subtitle" placeholder="Subtitle"></soso-text-input>
      <soso-text-input id="keywords" label="Up to 5 keywords" placeholder="Keywords"></soso-text-input>
      <div class="languageSelection">
        <span class="languageLabel">Language:</span>
        <select id="languageSelect">
          <template is="dom-repeat" items="[[languages]]">
            <option value$="[[item.code]]" selected$="{{item.selected}}">[[item.name]]</option>
          </template>
        </select>
      </div>
      <soso-checkbox id="private" label="Keep this card private"></soso-checkbox>
    </dialog-view>
  </template>
  <script>
    class EditCardDialog extends Polymer.Element {
      static get is() { return 'edit-card-dialog'; }
      static get properties() {
        return {
          _buttons: Array,
          iconMap: Object,
          languages: Array
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.iconMap = window._channelIcons;
      }

      _onImageSet(event) {
        let hasImage = event.detail.hasImage;
        if (hasImage) {
          this._imageCleared = false;
          this.$.clearImage.classList.remove("hidden");
        } else {
          this.$.clearImage.classList.add("hidden");
        }
      }

      _clearImage() {
        this._imageCleared = true;
        this.$.filePicker.clear();
        this.$.filePicker.image = null;
      }

      show(card) {
        this._buttons = [
          { id: 'cancel', label: "Cancel" },
          { id: 'content', label: "Edit content" },
          { id: 'save', label: "Save" }
        ];

        this._card = card;

        // initialize state
        this.$.filePicker.clear();
        this.$.title.value = card.summary.title || "";
        this.$.text.value = card.summary.text || "";
        this.$.keywords.value = card.keywords ? card.keywords.join(', ') : '';
        this.$.private.checked = card.private || false;
        this.$.filePicker.image = card.summary.imageURL;
        this._refreshLanguageList(card.summary.langCode);

        return this.$.dlg.show();
      }

      _refreshLanguageList(selectedLanguage) {
        const languages = [];
        const map = $core.languages;
        if (!selectedLanguage) {
          selectedLanguage = 'en';
        }
        for (const key of Object.keys(map)) {
          languages.push({
            code: key,
            name: map[key],
            selected: key === selectedLanguage
          });
        }
        this.set('languages', languages);
      }


      hide() {
        return this.$.dlg.hide();
      }

      _handleButton(event) {
        switch (event.detail.button.id) {
          case "content":
            this.dispatchEvent(new CustomEvent('edit-content', { bubbles: true, composed: true }));
            break;
          case "save":
            this._doSave();
            break;
          default:
            $dialogs.hide(this);
            break;
        }
      }

      _doSave() {
        let file = this.$.filePicker.file;
        if (file) {
          this.$.dlg.showProgress("Uploading image");
          $core.uploadImageFile(file, null, 500).then((fileInfo) => {
            return this._updateCard(fileInfo.fileId, fileInfo.url).then(() => {
              return this._onCardUpdate();
            });
          }).catch((err) => {
            console.error(err);
            this.$.dlg.showError(err.message || err || "Oops. Something went wrong.");
          });
        } else {
          this._updateCard(null).then(() => {
            return this._onCardUpdate();
          });
        }
      }

      _onCardUpdate() {
        return this._updateCardPrivacy().then(() => {
          $dialogs.hide(this);
          if (this._summary) {
            this._summary.private = this.$.private.checked;
            this.dispatchEvent(new CustomEvent('summary-updated', { bubbles: true, composed: true, detail: { summary: this._summary } }));
          }
        });
      }

      _updateCardPrivacy() {
        return new Promise((resolve, reject) => {
          let isPrivate = this.$.private.checked;
          if (isPrivate != this._card.private) {
            $core.updateCardPrivate(this._card.id, isPrivate).then(resolve).catch(reject);
          } else {
            resolve();
          }
        });
      }

      _updateCard(imageId, imageURL) {
        this.$.dlg.showProgress("Saving");
        let imgId = this._card.summary.imageId;
        let imgURL = this._card.summary.imageURL;
        if (imageId) {
          imgId = imageId;
          imgURL = imageURL;
        } else if (this._imageCleared) {
          imgId = null;
          imgURL = null;
        }
        let keywords = this._getKeywords();
        return $core.updateCardSummary(this._card.id, this.$.title.value.trim(), this.$.text.value.trim(), this.$.languageSelect.options[this.$.languageSelect.selectedIndex].value, null, imgId, imgURL, keywords).then((summary) => {
          this._summary = summary;
          this._summary.keywords = keywords;
        });
      }

      _getKeywords() {
        if (!this.$.keywords.value) {
          return [];
        }
        const keywords = [];
        let delimiter = ',';
        if (this.$.keywords.value.indexOf(',') < 0) {
          delimiter = " ";
        }
        const userKeys = this.$.keywords.value.split(delimiter);
        for (const k of userKeys) {
          const kw = k.trim().replace(/[^a-zA-Z\s]/g, '')
          if (kw.length > 0) {
            keywords.push(kw);
          }
          if (keywords.length >= 5) {
            break;
          }
        }
        return keywords;
      }

      // _getImageSize(imageUrl) {
      //   return new Promise((resolve, reject) => {
      //     if (imageUrl) {
      //       let img = new Image();
      //       img.addEventListener('load', () => {
      //         resolve([img.width, img.height]);
      //       });
      //       img.addEventListener('error', () => {
      //         resolve(null);
      //       });
      //       img.src = imageUrl;
      //     } else {
      //       resolve(null);
      //     }
      //   });
      // }
    }
    window.customElements.define(EditCardDialog.is, EditCardDialog);
  </script>
</dom-module>