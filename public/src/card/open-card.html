<link rel="import" href="open-card-header.html">

<dom-module id="open-card">
  <template>
    <style is="custom-style" include="app-styles iron-flex iron-flex-alignment">
      :host {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        transition: all 1s ease;
        z-index: 1;
        pointer-events: auto;
      }

      #container {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
        background: white;
        @apply --layout-vertical;
        opacity: 0;
        transition: opacity 1.2s ease;
      }

      #header {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        box-sizing: border-box;
        border-radius: 3px 3px 0 0;
        overflow: hidden;
        box-shadow: 0 1px 5px -1px rgba(0, 0, 0, 0.2);
      }

      #headerBuffer {
        display: block;
        box-sizing: border-box;
        height: 60px;
      }

      .animatable {
        transition: all 1s ease;
      }

      .content {
        position: relative;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      #dummyContent {
        max-width: 800px;
        margin: 0 auto;
        padding: 10px;
        font-size: 20px;
        color: #212121;
        text-align: center;
      }

      em {
        color: #1E88E5;
        font-style: normal;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 600px) {
        #dummyContent {
          font-size: 16px;
        }
      }
    </style>
    <div id="container" class="container">
      <div id="headerBuffer"></div>
      <div class="content flex">
        <div id="dummyContent">
          <p>Loading...</p>
        </div>
        <div id="cardView" class="hidden"></div>
      </div>
    </div>
    <open-card-header id="header" data="[[data]]"></open-card-header>
  </template>
  <script>
    class OpenCard extends Polymer.Element {
      static get is() { return "open-card"; }
      static get properties() {
        return {
          data: Object
        };
      }

      open(node) {
        this._refNode = node;
        return new Promise((resolve, reject) => {
          this.style.display = "block";
          requestAnimationFrame(() => {
            this.$.header.style.bottom = "initial";
            this.$.header.style.top = (this.offsetHeight - 60) + "px";
            this.$.header.classList.add("animatable");
            requestAnimationFrame(() => {
              this.$.header.style.top = "0px";
              resolve();
            });
            this.$.container.style.opacity = 1;
            let nodeRect = node.getBoundingClientRect();
            let cardRect = this.getBoundingClientRect();
            this.style.top = (nodeRect.top - cardRect.top) + "px";
            this.style.left = (nodeRect.left - cardRect.left) + "px";
            this.style.width = nodeRect.width + "px"
            this.style.height = nodeRect.height + "px";

            this._loadCard();
          });
        });
      }

      close(animate) {
        this._refNode = null;
        this.style.display = "none";
        this.$.header.style.bottom = "0";
        this.$.header.style.top = "initial"
        this.$.header.classList.remove("animatable");
        this.$.container.style.opacity = 0;
        this.style.top = 0;
        this.style.left = 0;
        this.style.width = "100%";
        this.style.height = "100%";
      }

      onPayment() {
        this.$.header.onPayment();
      }

      onImpressionPaid() {
        this.$.header.onImpressionPaid();
      }

      refreshLayout(cardNode) {
        if (this._refNode) {
          let nodeRect = this._refNode.getBoundingClientRect();
          let cardRect = cardNode.getBoundingClientRect();
          this.style.top = (nodeRect.top - cardRect.top) + "px";
          this.style.left = (nodeRect.left - cardRect.left) + "px";
          this.style.width = nodeRect.width + "px"
          this.style.height = nodeRect.height + "px";
        }
      }

      setPaymentStatus(value, negative) {
        this.$.header.setPaymentStatus(value, negative);
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      _loadCard() {
        if (this._loading) {
          return;
        }
        this._loading = true;
        this.$.dummyContent.classList.remove("hidden");
        this.$.cardView.classList.add("hidden");
        this._clearNode(this.$.cardView);
        let onLoaded = () => {
          this._loading = false;
          this.$.dummyContent.classList.add("hidden");
          this.$.cardView.classList.remove("hidden");
        };

        let packageName = this.data.cardType.package;
        if (packageName) {
          $core.cardManager.ensurePackage(packageName).then((packageInfo) => {
            Polymer.importHref(packageInfo.importHref, () => {
              onLoaded();
              let cardNode = document.createElement(packageInfo.channelComponent.viewerTag);
              cardNode.data = this.data.summary;
              this.$.cardView.appendChild(cardNode);
              // console.log("package info", packageInfo, JSON.stringify(this.data.summary));
            }, (err) => {
              onLoaded();
              console.error("Failed to load package '" + packageName + "'", err);
            });
          }).catch((err) => {
            onLoaded();
            console.error("Failed to load package '" + packageName + "'", err);
          });
        } else {
          this._loading = false;
          this.$.dummyContent.classList.add("hidden");
        }
      }
    }
    window.customElements.define(OpenCard.is, OpenCard);
  </script>
</dom-module>