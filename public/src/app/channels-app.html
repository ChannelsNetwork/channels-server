<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/import-href.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../bower_components/soso-router/soso-router.html">
<link rel="import" href="../../bower_components/soso-app-shell/soso-app-shell.html">
<link rel="import" href="../core/core.html">
<link rel="import" href="styles.html">
<link rel="import" href="nav-bar.html">

<dom-module id="channels-app">
  <template>
    <style is="custom-style" include="app-styles">
      #reloadingPanel {
        position: fixed;
        z-index: 100;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        color: inherit;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-align: center;
      }

      #balanceOverlay {
        position: fixed;
        z-index: 100;
        top: 0;
        right: 0;
        height: 50px;
        padding: 0 16px;
        background: var(--bg-yellow);
        color: #000;
        cursor: pointer;
      }

      @media (max-width: 600px) {
        #balancePanel {
          letter-spacing: initial;
          margin-left: 2px;
          padding: 0 10px;
          font-size: 15px;
        }
      }
    </style>
    <soso-router id="router" on-route-change="_onRouteChange"></soso-router>
    <soso-app-shell id="shell">
      <!-- Main Body -->
      <div slot="main">
        <div id="pages">
          <!-- Signin and registartion pages -->
          <sign-in-view class="signin page" data-href="../account/sign-in-view.html"></sign-in-view>
          <register-view class="register page" data-href="../account/register-view.html"></register-view>
          <register-image-view class="register-photo page" data-href="../account/register-image-view.html"></register-image-view>
          <request-recovery-view class="request-recovery page" data-href="../account/request-recovery-view.html"></request-recovery-view>
          <recover-account-view class="recover page" data-href="../account/recover-account-view.html"></recover-account-view>
          <!-- Account Pages -->
          <account-view class="account page" data-href="../account/account-view.html"></account-view>
          <edit-profile-view class="edit-profile page" data-href="../account/edit-profile-view.html"></edit-profile-view>
          <email-confirm-page class="confirm-email page" data-href="../account/email-confirm-page.html"></email-confirm-page>
          <!-- About Pages -->
          <about-view class="about page" data-href="../about/about-view.html"></about-view>
          <learn-card-development-view class="learn-card-development page" data-href="../about/learn-card-development-view.html"></learn-card-development-view>
          <!-- Balance Pages -->
          <balance-view class="balance page" data-href="../balance/balance-view.html"></balance-view>
          <withdraw-dialog class="withdraw page" data-href="../balance/withdraw-dialog.html"></withdraw-dialog>
          <!-- Channel Pages -->
          <channel-page class="channel page" data-href="../channel/channel-page.html"></channel-page>
          <channel-edit-page class="edit-channel page" data-href="../channel/channel-edit-page.html"></channel-edit-page>
          <!-- Subscription -->
          <subscriptions-page class="subscriptions page" data-href="../feed/subscriptions-page.html"></subscriptions-page>
          <!-- Feed/Card Pages -->
          <feed-page id="feed" class="feed page" data-href="../feed/feed-page.html"></feed-page>
          <search-view id="search" class="search page" data-href="../feed/search-view.html"></search-view>
          <compose-view class="compose page" data-href="../compose/compose-view.html"></compose-view>
          <card-page class="card page" data-href="../card/card-page.html"></card-page>
          <!-- Test pages -->
          <admin-users-view class="admin-users page" data-href="../admin/admin-users-view.html"></admin-users-view>
          <admin-cards-view class="admin-cards page" data-href="../admin/admin-cards-view.html"></admin-cards-view>
          <admin-goals-view class="admin-goals page" data-href="../admin/admin-goals-view.html"></admin-goals-view>
          <admin-withdrawals-view class="admin-withdrawals page" data-href="../admin/admin-withdrawals-view.html"></admin-withdrawals-view>
          <admin-publishers-view class="admin-publishers page" data-href="../admin/admin-publishers-view.html"></admin-publishers-view>

          <!-- <home-page id="home" class="home page" data-href="../home/home-page.html"></home-page> -->
        </div>
        <div id="balanceOverlay" class="horizontal layout center" style="display:none;">[[balanceDisplay]]</div>
      </div>
      <!-- Navigation Menu -->
      <div slot="nav">
        <nav-bar id="nav"></nav-bar>
      </div>
    </soso-app-shell>
    <!-- TODO: Right panel -->

    <div id="reloadingPanel" class="horizontal layout center hidden">
      <div style="width: 100%; box-sizing: border-box;">Channels is updating</div>
    </div>
    <confirm-dialog id="dlgConfirm"></confirm-dialog>
    <error-dialog id="dlgError"></error-dialog>
  </template>
  <script>
    class ChannelsApp extends Polymer.Element {
      static get is() { return "channels-app"; }
      static get properties() {
        return {
          balanceDisplay: String,
        }
      }

      constructor() {
        super();
        window.$app = this;
        window.$core = new CoreService();
        this._registrationListener = this._initializeBalance.bind(this);
        this._balanceListener = this._updateBalance.bind(this);
      }

      showMenu() {
        this.$.shell.showMenu();
      }

      hideMenu() {
        this.$.shell.hideMenu();
      }

      connectedCallback() {
        super.connectedCallback();
        window.$router = this.$.router;
        window.addEventListener('channels-server-version-change', () => {
          this.$.reloadingPanel.classList.remove("hidden");
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        });
        this._balance = $core.balance;
        window.addEventListener("channels-registration", this._registrationListener);
        window.addEventListener("channels-balance-effect", this._balanceListener);
      }

      _import(path) {
        return new Promise((resolve, reject) => {
          Polymer.importHref(this.resolveUrl(path), () => {
            resolve();
          }, (err) => {
            reject(err);
          });
        });
      }

      _onRouteChange(event) {
        // Called when navigation happens or on first load
        const cb = (event) => {
          this._handleRouteChange(event.detail.route);
        };

        // The current page can prevent this navigation 
        // If prevented, the previous path is pushed on to the
        // history stack so the URL in the address bar reverses to the prev value
        if (this._lastPage && this._lastPath && this._lastPage.validatePageChange) {
          this._lastPage.validatePageChange(event).then((proceed) => {
            if (proceed) {
              cb(event);
            } else {
              window.history.pushState(null, null, this._lastPath);
            }
          }).catch((err) => {
            if (err) console.warn(err);
            cb(event);
          });
        } else {
          cb(event);
        }
      }

      _handleRouteChange(route) {
        let segments = route.segments;
        let pageName = segments[0] || "feed";
        if (pageName === 'c') {
          pageName = "card";
        }
        const pages = this.shadowRoot.querySelectorAll(".page");
        let activePage = this.shadowRoot.querySelector("." + pageName);
        if (!activePage) {
          activePage = this.$.feed;
          pageName = "feed";
        }

        if (!(pageName === "card" || pageName === "channel")) {
          document.title = "Channels";
        }

        // hide nav menu
        this.hideMenu();

        // Close pending dialogs
        let dlgShell = document.getElementById("dialogShell");
        if (dlgShell) {
          this._clearNode(dlgShell);
        }

        // Notify current page that it is going away
        if (this._lastPage && (this._lastPage != activePage) && (this._lastPage.onDeactivate)) {
          try {
            this._lastPage.onDeactivate();
          } catch (err) { console.error("Error in page deactivate", err); }
        }
        this._lastPage = activePage;
        this._lastPath = route.path;

        // Import the new page
        const pageHref = activePage.dataset.href;
        this._import(pageHref).then(() => {
          // show the active page
          for (let i = 0; i < pages.length; i++) {
            let p = pages[i];
            if (p == activePage) {
              p.classList.remove("hidden");
            } else {
              p.classList.add("hidden");
            }
          }

          // let active page know
          setTimeout(() => {
            if (activePage.onActivate) {
              activePage.onActivate(route);
            }
          });
        });

        // Let navbar know
        this.$.nav.route = route;

        // notify analytics and return
        $core.analytics.page(window.location.pathname || "/");
        return pageName;
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      confirm(message, cancelText, okText) {
        return this._import("../dialogs/confirm-dialog.html").then(() => {
          return this.$.dlgConfirm.show(message, cancelText, okText);
        });
      }

      showError(error) {
        let message = error.message || error.toString();
        return this._import("../dialogs/error-dialog.html").then(() => {
          return this.$.dlgError.show(message);
        });
      }

      get scrollValue() {
        return (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement.scrollTop || document.body.scrollTop);
      }

      scrollTo(value) {
        if (window.scrollTo) {
          window.scrollTo(0, value);
        } else {
          document.documentElement.scrollTop = value;
          document.body.scrollTop = value;
        }
      }

      _initializeBalance() {
        console.log("_initializeBalance", $core.balance);
        this._balance = $core.balance;
      }

      _updateBalance() {
        console.log("_updateBalance");
        if (!this._balance) {
          return;
        }
        if (Math.abs(this._balance - $core.balance) < 0.002) {
          return;
        }
        console.log("_updateBalance: ", this._balance, $core.balance);
        this._balanceCountRemaining = 30;
        if (!this._balanceTimer) {
          this._balanceTimer = setInterval(() => {
            this._refreshBalance();
          }, 50);
        }
        this._refreshBalance();
      }

      _refreshBalance() {
        if (!this._balanceCountRemaining) {
          this._balanceCountRemaining = 0;
        }
        if (this._balanceCountRemaining <= 0) {
          this.$.balanceOverlay.style.display = "none";
          clearInterval(this._balanceTimer);
          this._balanceTimer = null;
          console.log("_refreshBalance: Closing", this._balance, $core.balance);
          return;
        }
        const counter = this._balanceCountRemaining > 25 ? 20 : Math.max(1, this._balanceCountRemaining - 5);
        if (counter <= 20) {
          const diff = $core.balance - this._balance;
          this._balance += diff / counter;
          console.log("Revising balance to " + this._balance, diff, counter);
        }
        const balanceDisplay = "ℂ" + (this._balance ? (Math.floor(this._balance * 1000) / 1000).toFixed(3) : "0.000");
        this.set('balanceDisplay', balanceDisplay);
        this._balanceCountRemaining--;
        this.$.balanceOverlay.style.display = "";
        console.log("_refreshBalance: Updating", this._balance, $core.balance, balanceDisplay);
      }
    }
    window.customElements.define(ChannelsApp.is, ChannelsApp);
  </script>
</dom-module>