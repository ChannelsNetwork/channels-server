<dom-module id="admin-goals-view">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #container {
        margin: 0 auto;
        padding: 20px 16px;
      }

      .table {
        display: table;
        border-collapse: collapse;
        font-size: 12px;
        margin: 30px 0 50px;
      }

      .headerRow {
        display: table-row;
      }

      .headerCell {
        display: table-cell;
        font-weight: bold;
        border: 1px solid #aaa;
        padding: 3px;
      }

      .row {
        display: table-row;
      }

      .rowHeader1 {
        font-weight: bold;
      }

      .rowHeader2 {
        font-weight: bold;
        padding-left: 20px !important;
      }

      .rowHeader3 {
        font-weight: bold;
        padding-left: 40px !important;
      }

      .rowHeader4 {
        font-weight: bold;
        padding-left: 60px !important;
      }

      .cell {
        display: table-cell;
        border: 1px solid #aaa;
        padding: 3px;
      }

      .center {
        text-align: center;
      }

      .right {
        text-align: right;
      }

      .fixed {
        width: 60px;
      }
    </style>
    <div id="container">
      <h1>Channels Metrics</h1>
      <div class="table">
        <div class="headerRow">
          <div class="headerCell"></div>
          <div class="headerCell right fixed">Today</div>
          <div class="headerCell right fixed">Yesterday</div>
          <div class="headerCell right fixed">2 days ago</div>
          <div class="headerCell right fixed">3 days ago</div>
          <div class="headerCell right fixed">4 days ago</div>
          <div class="headerCell right fixed">5 days ago</div>
          <div class="headerCell right fixed">6 days ago</div>
        </div>
        <div class="row">
          <div class="cell rowHeader1">users</div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
        </div>
        <div class="row">
          <div class="cell rowHeader2">total</div>
          <div class="cell right">[[userDays.0.all]]</div>
          <div class="cell right">[[userDays.1.all]]</div>
          <div class="cell right">[[userDays.2.all]]</div>
          <div class="cell right">[[userDays.3.all]]</div>
          <div class="cell right">[[userDays.4.all]]</div>
          <div class="cell right">[[userDays.5.all]]</div>
          <div class="cell right">[[userDays.6.all]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">with identity</div>
          <div class="cell right">[[userDays.0.withIdentity]]</div>
          <div class="cell right">[[userDays.1.withIdentity]]</div>
          <div class="cell right">[[userDays.2.withIdentity]]</div>
          <div class="cell right">[[userDays.3.withIdentity]]</div>
          <div class="cell right">[[userDays.4.withIdentity]]</div>
          <div class="cell right">[[userDays.5.withIdentity]]</div>
          <div class="cell right">[[userDays.6.withIdentity]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">repeat visitors</div>
          <div class="cell right">[[userDays.0.returning]]</div>
          <div class="cell right">[[userDays.1.returning]]</div>
          <div class="cell right">[[userDays.2.returning]]</div>
          <div class="cell right">[[userDays.3.returning]]</div>
          <div class="cell right">[[userDays.4.returning]]</div>
          <div class="cell right">[[userDays.5.returning]]</div>
          <div class="cell right">[[userDays.6.returning]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader4">with identity</div>
          <div class="cell right">[[userDays.0.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.1.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.2.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.3.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.4.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.5.returningWithIdentity]]</div>
          <div class="cell right">[[userDays.6.returningWithIdentity]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">publishers</div>
          <div class="cell right">[[userDays.0.publishers]]</div>
          <div class="cell right">[[userDays.1.publishers]]</div>
          <div class="cell right">[[userDays.2.publishers]]</div>
          <div class="cell right">[[userDays.3.publishers]]</div>
          <div class="cell right">[[userDays.4.publishers]]</div>
          <div class="cell right">[[userDays.5.publishers]]</div>
          <div class="cell right">[[userDays.6.publishers]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader2">excess balance</div>
          <div class="cell right">[[userDays.0.balance]]</div>
          <div class="cell right">[[userDays.1.balance]]</div>
          <div class="cell right">[[userDays.2.balance]]</div>
          <div class="cell right">[[userDays.3.balance]]</div>
          <div class="cell right">[[userDays.4.balance]]</div>
          <div class="cell right">[[userDays.5.balance]]</div>
          <div class="cell right">[[userDays.6.balance]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">with identity</div>
          <div class="cell right">[[userDays.0.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.1.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.2.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.3.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.4.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.5.balanceWithIdentity]]</div>
          <div class="cell right">[[userDays.6.balanceWithIdentity]]</div>
        </div>

        <div class="row">
          <div class="cell rowHeader1">cards</div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
        </div>
        <div class="row">
          <div class="cell rowHeader2">total</div>
          <div class="cell right">[[cardDays.0.all]]</div>
          <div class="cell right">[[cardDays.1.all]]</div>
          <div class="cell right">[[cardDays.2.all]]</div>
          <div class="cell right">[[cardDays.3.all]]</div>
          <div class="cell right">[[cardDays.4.all]]</div>
          <div class="cell right">[[cardDays.5.all]]</div>
          <div class="cell right">[[cardDays.6.all]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">deleted</div>
          <div class="cell right">[[cardDays.0.deleted]]</div>
          <div class="cell right">[[cardDays.1.deleted]]</div>
          <div class="cell right">[[cardDays.2.deleted]]</div>
          <div class="cell right">[[cardDays.3.deleted]]</div>
          <div class="cell right">[[cardDays.4.deleted]]</div>
          <div class="cell right">[[cardDays.5.deleted]]</div>
          <div class="cell right">[[cardDays.6.deleted]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">private</div>
          <div class="cell right">[[cardDays.0.private]]</div>
          <div class="cell right">[[cardDays.1.private]]</div>
          <div class="cell right">[[cardDays.2.private]]</div>
          <div class="cell right">[[cardDays.3.private]]</div>
          <div class="cell right">[[cardDays.4.private]]</div>
          <div class="cell right">[[cardDays.5.private]]</div>
          <div class="cell right">[[cardDays.6.private]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">blocked</div>
          <div class="cell right">[[cardDays.0.blocked]]</div>
          <div class="cell right">[[cardDays.1.blocked]]</div>
          <div class="cell right">[[cardDays.2.blocked]]</div>
          <div class="cell right">[[cardDays.3.blocked]]</div>
          <div class="cell right">[[cardDays.4.blocked]]</div>
          <div class="cell right">[[cardDays.5.blocked]]</div>
          <div class="cell right">[[cardDays.6.blocked]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">ads</div>
          <div class="cell right">[[cardDays.0.ads]]</div>
          <div class="cell right">[[cardDays.1.ads]]</div>
          <div class="cell right">[[cardDays.2.ads]]</div>
          <div class="cell right">[[cardDays.3.ads]]</div>
          <div class="cell right">[[cardDays.4.ads]]</div>
          <div class="cell right">[[cardDays.5.ads]]</div>
          <div class="cell right">[[cardDays.6.ads]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">promoted</div>
          <div class="cell right">[[cardDays.0.promoted]]</div>
          <div class="cell right">[[cardDays.1.promoted]]</div>
          <div class="cell right">[[cardDays.2.promoted]]</div>
          <div class="cell right">[[cardDays.3.promoted]]</div>
          <div class="cell right">[[cardDays.4.promoted]]</div>
          <div class="cell right">[[cardDays.5.promoted]]</div>
          <div class="cell right">[[cardDays.6.promoted]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">budget</div>
          <div class="cell right">[[cardDays.0.budget]]</div>
          <div class="cell right">[[cardDays.1.budget]]</div>
          <div class="cell right">[[cardDays.2.budget]]</div>
          <div class="cell right">[[cardDays.3.budget]]</div>
          <div class="cell right">[[cardDays.4.budget]]</div>
          <div class="cell right">[[cardDays.5.budget]]</div>
          <div class="cell right">[[cardDays.6.budget]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">spent</div>
          <div class="cell right">[[cardDays.0.spent]]</div>
          <div class="cell right">[[cardDays.1.spent]]</div>
          <div class="cell right">[[cardDays.2.spent]]</div>
          <div class="cell right">[[cardDays.3.spent]]</div>
          <div class="cell right">[[cardDays.4.spent]]</div>
          <div class="cell right">[[cardDays.5.spent]]</div>
          <div class="cell right">[[cardDays.6.spent]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">revenue</div>
          <div class="cell right">[[cardDays.0.revenue]]</div>
          <div class="cell right">[[cardDays.1.revenue]]</div>
          <div class="cell right">[[cardDays.2.revenue]]</div>
          <div class="cell right">[[cardDays.3.revenue]]</div>
          <div class="cell right">[[cardDays.4.revenue]]</div>
          <div class="cell right">[[cardDays.5.revenue]]</div>
          <div class="cell right">[[cardDays.6.revenue]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">refunds</div>
          <div class="cell right">[[cardDays.0.refunds]]</div>
          <div class="cell right">[[cardDays.1.refunds]]</div>
          <div class="cell right">[[cardDays.2.refunds]]</div>
          <div class="cell right">[[cardDays.3.refunds]]</div>
          <div class="cell right">[[cardDays.4.refunds]]</div>
          <div class="cell right">[[cardDays.5.refunds]]</div>
          <div class="cell right">[[cardDays.6.refunds]]</div>
        </div>

      </div>
    </div>
  </template>
  <script>
    class AdminGoalsView extends Polymer.Element {
      static get is() { return 'admin-goals-view'; }
      static get properties() {
        return {
          userDays: Array
        };
      }

      onActivate() {
        $core.register().then((info) => {
          if (!$core.profile || !$core.profile.handle || !info.admin) {
            setTimeout(() => {
              $router.goto("");
              return;
            }, 600);
            return;
          }
          this._refresh();
        }).catch((err) => {
          console.error(err);
          setTimeout(() => {
            $router.goto("");
          }, 600);
        });
      }

      _refresh() {
        this.set('userDays', []);
        $core.admin_getGoals().then((response) => {
          this._refreshUsers(response);
          this._refreshCards(response);
        });
      }

      _refreshUsers(response) {
        const days = [];
        let baseDay;
        let startingPeriodIndex = 0;
        for (let i = 0; i < response.userBins.length; i++) {
          const userDay = response.userBins[i];
          if (userDay._id === 0) {
            baseDay = userDay;
            startingPeriodIndex++;
          } else if (userDay._id > 0) {
            while (userDay._id > response.periodsStarting[startingPeriodIndex]) {
              const fillerDay = {
                all: baseDay.newUsers,
                withIdentity: baseDay.newUsersWithIdentity,
                returning: baseDay.returning,
                returningWithIdentity: baseDay.returningWithIdentity,
                publishers: baseDay.publishers,
                balance: Math.round(baseDay.totalBalance),
                balanceWithIdentity: Math.round(baseDay.totalBalanceWithIdentity)
              };
              days.push(fillerDay);
              startingPeriodIndex++;
            }
            const day = {
              all: baseDay.newUsers + userDay.newUsers + " (+" + userDay.newUsers + ")",
              withIdentity: baseDay.newUsersWithIdentity + userDay.newUsersWithIdentity + " (+" + userDay.newUsersWithIdentity + ")",
              returning: baseDay.returning + userDay.returning + " (+" + userDay.returning + ")",
              returningWithIdentity: baseDay.returningWithIdentity + userDay.returningWithIdentity + " (+" + userDay.returningWithIdentity + ")",
              publishers: baseDay.publishers + userDay.publishers + " (+" + userDay.publishers + ")",
              balance: Math.round(baseDay.totalBalance + userDay.totalBalance) + " (+" + Math.round(userDay.totalBalance) + ")",
              balanceWithIdentity: Math.round(baseDay.totalBalanceWithIdentity + userDay.totalBalanceWithIdentity) + " (+" + Math.round(userDay.totalBalanceWithIdentity) + ")"
            };
            days.push(day);
            baseDay.newUsers += userDay.newUsers;
            baseDay.newUsersWithIdentity += userDay.newUsersWithIdentity;
            baseDay.totalBalance += userDay.totalBalance;
            baseDay.totalBalanceWithIdentity += userDay.totalBalanceWithIdentity;
            baseDay.returning += userDay.returning;
            baseDay.returningWithIdentity += userDay.returningWithIdentity;
            baseDay.publishers += userDay.publishers;
            startingPeriodIndex++;
          }
        }
        while (startingPeriodIndex < response.periodsStarting.length) {
          const fillerDay = {
            all: baseDay.newUsers,
            withIdentity: baseDay.newUsersWithIdentity,
            returning: baseDay.returning,
            returningWithIdentity: baseDay.returningWithIdentity,
            publishers: baseDay.publishers,
            balance: Math.round(baseDay.totalBalance),
            balanceWithIdentity: Math.round(baseDay.totalBalanceWithIdentity)
          };
          days.push(fillerDay);
          startingPeriodIndex++;
        }
        this.set('userDays', days.reverse());
      }

      _refreshCards(response) {
        const days = [];
        let baseDay;
        let startingPeriodIndex = 0;
        for (let i = 0; i < response.cardBins.length; i++) {
          const newDay = response.cardBins[i];
          if (newDay._id === 0) {
            baseDay = newDay;
            startingPeriodIndex++;
          } else if (newDay._id > 0) {
            while (newDay._id > response.periodsStarting[startingPeriodIndex]) {
              const fillerDay = {
                all: baseDay.total,
                deleted: baseDay.deleted,
                private: baseDay.private,
                blocked: baseDay.blocked,
                ads: baseDay.ads,
                promoted: baseDay.promoted,
                budget: Math.round(baseDay.budget),
                spent: Math.round(baseDay.spent),
                revenue: Math.round(baseDay.revenue),
                refunds: baseDay.refunds
              };
              days.push(fillerDay);
              startingPeriodIndex++;
            }
            const day = {
              all: baseDay.total + newDay.total + " (+" + newDay.total + ")",
              deleted: baseDay.deleted + newDay.deleted + " (+" + newDay.deleted + ")",
              private: baseDay.private + newDay.private + " (+" + newDay.private + ")",
              blocked: baseDay.blocked + newDay.blocked + " (+" + newDay.blocked + ")",
              ads: baseDay.ads + newDay.ads + " (+" + newDay.ads + ")",
              promoted: baseDay.promoted + newDay.promoted + " (+" + newDay.promoted + ")",
              budget: Math.round(baseDay.budget + newDay.budget) + " (+" + Math.round(newDay.budget) + ")",
              spent: Math.round(baseDay.spent + newDay.spent) + " (+" + Math.round(newDay.spent) + ")",
              revenue: Math.round(baseDay.revenue + newDay.revenue) + " (+" + Math.round(newDay.revenue) + ")",
              refunds: baseDay.refunds + newDay.refunds + " (+" + newDay.refunds + ")",
            };
            days.push(day);
            baseDay.total += newDay.total;
            baseDay.deleted += newDay.deleted;
            baseDay.private += newDay.private;
            baseDay.blocked += newDay.blocked;
            baseDay.ads += newDay.ads;
            baseDay.promoted += newDay.promoted;
            baseDay.budget += newDay.budget;
            baseDay.spent += newDay.spent;
            baseDay.revenue += newDay.revenue;
            baseDay.refunds += newDay.refunds;
            startingPeriodIndex++;
          }
        }
        while (startingPeriodIndex < response.periodsStarting.length) {
          const fillerDay = {
            all: baseDay.total,
            deleted: baseDay.deleted,
            private: baseDay.private,
            blocked: baseDay.blocked,
            ads: baseDay.ads,
            promoted: baseDay.promoted,
            budget: Math.round(baseDay.budget),
            spent: Math.round(baseDay.spent),
            revenue: Math.round(baseDay.revenue),
            refunds: baseDay.refunds
          };
          days.push(fillerDay);
          startingPeriodIndex++;
        }
        this.set('cardDays', days.reverse());
      }
    }
    window.customElements.define(AdminGoalsView.is, AdminGoalsView);
  </script>
</dom-module>