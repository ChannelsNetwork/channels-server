<dom-module id="admin-goals-view">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #container {
        margin: 0 auto;
        padding: 20px 16px;
      }

      .table {
        display: table;
        border-collapse: collapse;
        font-size: 12px;
        margin: 30px 0 50px;
      }

      .headerRow {
        display: table-row;
      }

      .headerCell {
        display: table-cell;
        font-weight: bold;
        border: 1px solid #aaa;
        padding: 3px;
      }

      .row {
        display: table-row;
      }

      .rowHeader1 {
        font-weight: bold;
      }

      .rowHeader2 {
        font-weight: bold;
        padding-left: 20px !important;
      }

      .rowHeader3 {
        font-weight: bold;
        padding-left: 40px !important;
      }

      .rowHeader4 {
        font-weight: bold;
        padding-left: 60px !important;
      }

      .cell {
        display: table-cell;
        border: 1px solid #aaa;
        padding: 3px;
      }

      .center {
        text-align: center;
      }

      .right {
        text-align: right;
      }

      .fixed {
        width: 60px;
      }
    </style>
    <div id="container">
      <h1>Channels Metrics</h1>
      <div class="table">
        <div class="headerRow">
          <div class="headerCell"></div>
          <div class="headerCell right fixed">Today</div>
          <div class="headerCell right fixed">Yesterday</div>
          <div class="headerCell right fixed">2 days ago</div>
          <div class="headerCell right fixed">3 days ago</div>
          <div class="headerCell right fixed">4 days ago</div>
          <div class="headerCell right fixed">5 days ago</div>
          <div class="headerCell right fixed">6 days ago</div>
        </div>
        <div class="row">
          <div class="cell rowHeader1">users</div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
          <div class="cell right"></div>
        </div>
        <div class="row">
          <div class="cell rowHeader2">counts</div>
          <div class="cell right">[[days.0.users.all]]</div>
          <div class="cell right">[[days.1.users.all]]</div>
          <div class="cell right">[[days.2.users.all]]</div>
          <div class="cell right">[[days.3.users.all]]</div>
          <div class="cell right">[[days.4.users.all]]</div>
          <div class="cell right">[[days.5.users.all]]</div>
          <div class="cell right">[[days.6.users.all]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">with identity</div>
          <div class="cell right">[[days.0.users.withIdentity]]</div>
          <div class="cell right">[[days.1.users.withIdentity]]</div>
          <div class="cell right">[[days.2.users.withIdentity]]</div>
          <div class="cell right">[[days.3.users.withIdentity]]</div>
          <div class="cell right">[[days.4.users.withIdentity]]</div>
          <div class="cell right">[[days.5.users.withIdentity]]</div>
          <div class="cell right">[[days.6.users.withIdentity]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">returning</div>
          <div class="cell right">[[days.0.users.returning]]</div>
          <div class="cell right">[[days.1.users.returning]]</div>
          <div class="cell right">[[days.2.users.returning]]</div>
          <div class="cell right">[[days.3.users.returning]]</div>
          <div class="cell right">[[days.4.users.returning]]</div>
          <div class="cell right">[[days.5.users.returning]]</div>
          <div class="cell right">[[days.6.users.returning]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader4">with identity</div>
          <div class="cell right">[[days.0.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.1.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.2.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.3.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.4.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.5.users.returningWithIdentity]]</div>
          <div class="cell right">[[days.6.users.returningWithIdentity]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">publishers</div>
          <div class="cell right">[[days.0.users.publishers]]</div>
          <div class="cell right">[[days.1.users.publishers]]</div>
          <div class="cell right">[[days.2.users.publishers]]</div>
          <div class="cell right">[[days.3.users.publishers]]</div>
          <div class="cell right">[[days.4.users.publishers]]</div>
          <div class="cell right">[[days.5.users.publishers]]</div>
          <div class="cell right">[[days.6.users.publishers]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader2">excess balance</div>
          <div class="cell right">[[days.0.users.balance]]</div>
          <div class="cell right">[[days.1.users.balance]]</div>
          <div class="cell right">[[days.2.users.balance]]</div>
          <div class="cell right">[[days.3.users.balance]]</div>
          <div class="cell right">[[days.4.users.balance]]</div>
          <div class="cell right">[[days.5.users.balance]]</div>
          <div class="cell right">[[days.6.users.balance]]</div>
        </div>
        <div class="row">
          <div class="cell rowHeader3">with identity</div>
          <div class="cell right">[[days.0.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.1.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.2.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.3.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.4.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.5.users.balanceWithIdentity]]</div>
          <div class="cell right">[[days.6.users.balanceWithIdentity]]</div>
        </div>
      </div>
    </div>
  </template>
  <script>
    class AdminGoalsView extends Polymer.Element {
      static get is() { return 'admin-goals-view'; }
      static get properties() {
        return {
          days: Array
        };
      }

      onActivate() {
        $core.register().then((info) => {
          if (!$core.profile || !$core.profile.handle || !info.admin) {
            setTimeout(() => {
              $router.goto("");
              return;
            }, 600);
            return;
          }
          this._refresh();
        }).catch((err) => {
          console.error(err);
          setTimeout(() => {
            $router.goto("");
          }, 600);
        });
      }

      _refresh() {
        this.set('days', []);
        $core.admin_getGoals().then((response) => {
          const days = [];
          let baseDay;
          for (let i = 0; i < response.userBins.length; i++) {
            const userDay = response.userBins[i];
            if (userDay._id === 0) {
              baseDay = userDay;
            } else if (userDay._id > 0) {
              day = {
                all: baseDay.newUsers + userDay.newUsers + " + " + userDay.newUsers,
                withIdentity: baseDay.newUsersWithIdentity + userDay.newUsersWithIdentity + " + " + userDay.newUsersWithIdentity,
                returning: baseDay.returning + userDay.returning + " + " + userDay.returning,
                returningWithIdentity: baseDay.returningWithIdentity + userDay.returningWithIdentity + " + " + userDay.returningWithIdentity,
                publishers: baseDay.publishers + userDay.publishers + " + " + userDay.publishers,
                balance: Math.round(baseDay.totalExcessBalance + userDay.totalExcessBalance) + " + " + Math.round(userDay.totalExcessBalance),
                balanceWithIdentity: Math.round(baseDay.totalExcessBalanceWithIdentity + userDay.totalExcessBalanceWithIdentity) + " + " + Math.round(userDay.totalExcessBalanceWithIdentity)
              };
              days.push(day);
              baseDay.newUsers += userDay.newUsers;
              baseDay.newUsersWithIdentity += userDay.newUsersWithIdentity;
              baseDay.totalExcessBalance += userDay.totalExcessBalance;
              baseDay.totalExcessBalanceWithIdentity += userDay.totalExcessBalanceWithIdentity;
              baseDay.returning += userDay.returning;
              baseDay.returningWithIdentity += userDay.returningWithIdentity;
              baseDay.publishers += userDay.publishers;
            }
          }
          this.set('days', days.reverse());
        });
      }
    }
    window.customElements.define(AdminGoalsView.is, AdminGoalsView);
  </script>
</dom-module>