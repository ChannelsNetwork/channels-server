<link rel="import" href="../card/card-view.html">
<link rel="import" href="../card/ad/amazon-ad-card.html">
<link rel="import" href="../card/ad/image-ad-card.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">

<dom-module id="card-feed">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #container {
        width: 100%;
        box-sizing: border-box;
      }

      card-view,
      amazon-ad-card,
      image-ad-card {
        height: var(--grid-card-height, 400px);
        box-sizing: border-box;
        -ms-flex: 1 1 0.000000001px;
        -webkit-flex: 1;
        flex: 1;
        -webkit-flex-basis: 0.000000001px;
        flex-basis: 0.000000001px;
        min-width: 300px;
        width: 300px;
        max-width: 300px;
        margin: 8px;
      }
    </style>
    <div id="container" class="horizontal layout center-justified wrap">
      <dom-repeat items="[[items]]">
        <template>
          <template is="dom-if" if="{{_isImageAd(item)}}">
            <image-ad-card data="[[item]]" on-impression="_onImpression" on-card-deleted="_onCardDeleted"></image-ad-card>
          </template>
          <template is="dom-if" if="{{_isAmazonAd(item)}}">
            <amazon-ad-card data="[[item]]" on-impression="_onImpression" on-card-deleted="_onCardDeleted"></amazon-ad-card>
          </template>
          <template is="dom-if" if="{{_isNotAd(item)}}">
            <card-view data="[[item]]" on-impression="_onImpression" on-card-open="_onCardOpenRequest" on-card-deleted="_onCardDeleted"></card-view>
          </template>
        </template>
      </dom-repeat>
    </div>
  </template>
  <script>
    class CardFeed extends Polymer.Element {
      static get is() { return "card-feed"; }
      static get properties() {
        return {
          nominalWidth: {
            type: Number,
            value: 300
          },
          items: Array
        };
      }

      constructor() {
        super();
        let ht = Math.min(Math.max(400, 0.6 * window.innerHeight), 500);
        let imgHt = ht < 480 ? "170px" : "250px";
        this.updateStyles({
          '--grid-card-height': ht + "px",
          '--card-img-height': imgHt
        });
      }

      _isImageAd(item) {
        return (item && item.summary && item.summary.imageId && item.summary.linkUrl && !item.summary.iframeUrl);
      }

      _isIFrameAd(item) {
        return (item && item.summary && item.summary.iframeUrl);
      }

      _isNotAd(item) {
        return !this._isImageAd(item) && !this._isIFrameAd(item);
      }

      _onImpression(event) {
        event.stopPropagation();
        let card = event.model.item;
        if (card) {
          this.dispatchEvent(new CustomEvent('impression', { bubbles: true, composed: true, detail: { card: card, view: event.target } }));
        }
      }

      connectedCallback() {
        super.connectedCallback();
        Polymer.RenderStatus.beforeNextRender(this, function () {
          this.refreshLayout();
        });
      }

      refreshLayout() {
        this._refreshAttempts = 0;
        this._refreshStyles();
      }

      _refreshStyles() {
        let w = this.offsetWidth;
        if (w === 0) {
          if (this._refreshAttempts < 10) {
            this._refreshAttempts++;
            setTimeout(() => {
              this._refreshStyles();
            }, 50);
          }
          return;
        }
        let cols = Math.max(1, Math.min(3, Math.floor(w / this.nominalWidth)));
        let colWidth = Math.floor((100 - (cols * 1.1 * 2)) / cols);
        if (this._colWidth != colWidth) {
          this._colWidth = colWidth;
          this.updateStyles({
            '--grid-card-width': colWidth + "%",
            '--grid-card-margin': Math.floor((1.1 * w) / 100) + "px"
          });
        }
        this._refreshAttempts = 0;
      }

      _onCardOpenRequest(event) {
        event.stopPropagation();
        this.dispatchEvent(new CustomEvent('card-open-request', { bubbles: true, composed: true, detail: { card: event.target, item: event.model.item } }));
      }

      _onCardDeleted(event) {
        const newItems = [];
        const cardId = event.detail.card.id;
        for (const item of this.items) {
          if (item.id !== cardId) {
            newItems.push(item);
          }
        }
        this.set('items', newItems);
      }
    }
    window.customElements.define(CardFeed.is, CardFeed);
  </script>
</dom-module>