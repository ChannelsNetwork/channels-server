<link rel="import" href="feed-mixin.html">
<link rel="import" href="card-feed.html">
<link rel="import" href="../channel-icons.html">
<link rel="import" href="../home/publicity-panel.html">

<dom-module id="feed-view">
  <template>
    <style is="custom-style" include="app-styles feed-styles">
      #composeButton {
        position: fixed;
        cursor: pointer;
        bottom: 32px;
        right: 32px;
        background: var(--bg-yellow);
        color: var(--bg-dark);
        padding: 16px;
        border-radius: 50%;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        z-index: 1;
      }

      #composeButton:active {
        color: var(--bg-yellow);
        background: var(--bg-dark);
      }

      .main {
        padding: 0 0 200px;
      }

      @media (max-width: 600px) {
        .composeButton {
          bottom: 24px;
          right: 16px;
        }
      }

      #buttons {
        margin: 25px 0;
        text-align: center;
      }
    </style>
    <div id="spacer" class="spacer"></div>
    <publicity-panel id="pubPanel" class="hidden" on-create-card="_compose"></publicity-panel>
    <div class="main">
      <div id="noItems" class="hidden">There are no matching cards in this category.</div>
      <card-feed id="feed" items="[[items]]" on-card-open-request="_onCardOpenRequest" on-impression="_onCardImpression"></card-feed>
      <div id="buttons" style="display:none;">
        <button id="btnMore" on-click="_onMoreClick">More</button>
      </div>
    </div>
    <soso-icon id="composeButton" on-click="_compose" icon="add" icon-map="[[iconMap]]"></soso-icon>
    <insufficient-funds-dialog id="insufficientFunds"></insufficient-funds-dialog>
  </template>
  <script>
    class FeedView extends FeedMixin(Polymer.Element) {
      static get is() { return 'feed-view'; }

      _onActivate() {
        this._active = true;
        this._refreshHomePanelVisibility();
        this._detachListseners();
      }

      _onDeactivate() {
        this._active = false;
        this._detachListseners();
      }

      _detachListseners() {
        if (this._statusListener) {
          window.removeEventListener('channels-user-status', this._statusListener);
          this._statusListener = null;
        }
      }

      _parseRoute(route) {
        let feedName = "recommended";
        let cardId = null;
        if (route && route.segments) {
          if (route.segments.length > 1) {
            feedName = route.segments[1];
          }
          if (route.segments.length > 2) {
            cardId = route.segments[2];
          }
        }
        this._feedName = feedName;
        this._refreshPromotionVisibility();
        this._refreshHomePanelVisibility();

        if (!this._statusListener) {
          this._statusListener = () => {
            if (this._active) {
              this.$.pubPanel.refresh();
            }
          };
          window.addEventListener("channels-user-status", this._statusListener);
        }

        return {
          type: "feed",
          feedName: feedName,
          path: '/feed/' + feedName,
          count: 10,
          cardId: cardId,
          channel: null
        };
      }

      _refreshPromotionVisibility() {
        let showPubPanel = (this._feedName === "recommended" && $core.publishSubsidiesRemainingToday);
        if (showPubPanel) {
          this.$.pubPanel.classList.remove("hidden");
          this.$.pubPanel.refresh();
        } else {
          this.$.pubPanel.classList.add("hidden");
        }
      }

      _refreshHomePanelVisibility() {
        if ($app.homePanelVisible) {
          this.$.spacer.classList.add("hidden");
        } else {
          this.$.spacer.classList.remove("hidden");
        }
      }

      _compose() {
        if (!$core.profile || !$core.profile.handle) {
          $router.goto("/register", { message: "Before you compose your first card, you must first register an identity.", returnRoute: { success: "compose", cancel: "feed" } });
          return;
        }
        $router.goto("/compose");
      }

      _onMoreUpdated(value) {
        this.$.btnMore.disabled = false;
        if (value) {
          this.$.buttons.style.display = "";
        } else {
          this.$.buttons.style.display = "none";
        }
      }

      _onMoreClick() {
        this.$.btnMore.disabled = true;
        this._fetchMore();
      }
    }
    window.customElements.define(FeedView.is, FeedView);
  </script>
</dom-module>