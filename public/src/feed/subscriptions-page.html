<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/soso-app-header/soso-app-header.html">
<link rel="import" href="../app/channels-bar.html">
<link rel="import" href="../app/title-bar.html">
<link rel="import" href="../channel/channel-card.html">

<dom-module id="subscriptions-page">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
      }

      #noItems {
        padding: 40px 20px;
        font-size: 16px;
        letter-spacing: 0.05em;
        text-align: center;
      }

      #cardsPanel {
        max-width: 1264px;
        margin: 0 auto;
        box-sizing: border-box;
        padding: 20px 0;
      }

      channel-card {
        box-sizing: border-box;
        margin: 20px 8px 8px 35px;
      }

      @media (max-width: 600px) {
        channel-card {
          margin: 20px 5px 8px 24px;
        }
      }
    </style>
    <soso-app-header collapse-height="50">
      <channels-bar id="cbar"></channels-bar>
      <title-bar text="My Subscriptions"></title-bar>
    </soso-app-header>
    <div id="noItems" class="hidden">You're not subscribed to any channels.</div>
    <div id="cardsPanel" class="hidden horizontal layout center-justified wrap">
      <dom-repeat items="[[channels]]">
        <template>
          <channel-card channel="[[item]]" color-state></channel-card>
        </template>
      </dom-repeat>
    </div>
  </template>
  <script>
    class SubscriptionsPage extends Polymer.Element {
      static get is() { return 'subscriptions-page'; }

      onActivate() {
        $core.register().then((info) => {
          this.$.cbar.activate();
          this.channels = [];
          this._refresh();
        }).catch((err) => {
          console.error(err);
          setTimeout(() => {
            $router.goto("");
          }, 600);
        });
      }

      onDeactivate() {
        this.$.cbar.deactivate();
      }

      _refresh() {
        this._nextPageRef = null;
        $core.getChannels("subscribed", 200).then((result) => {
          this._nextPageRef = result.nextPageReference;
          this.channels = result.channels || [];
          if (this.channels.length) {
            this.$.cardsPanel.classList.remove("hidden");
            this.$.noItems.classList.add("hidden");
          } else {
            this.$.cardsPanel.classList.add("hidden");
            this.$.noItems.classList.remove("hidden");
          }
        }).catch(err => {
          console.error(err);
          $app.showError(err);
        });
      }
    }
    window.customElements.define(SubscriptionsPage.is, SubscriptionsPage);
  </script>
</dom-module>