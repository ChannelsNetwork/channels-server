<link rel="import" href="onesignal-lib.html" async>

<dom-module id="notifications-view">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        background: #4E342E;
        font-size: 20px;
      }

      .shell {
        min-height: 100vh;
      }

      #container {
        max-width: 600px;
        padding: 16px;
        margin: 0 auto;
        box-sizing: border-box;
      }

      button {
        padding-left: 0;
      }

      @media (max-width: 400px) {
        h2 {
          font-size: 36px;
        }
        button {
          font-size: 16px;
          letter-spacing: initial;
        }
        :host {
          font-size: 16px;
        }
      }
    </style>
    <div class="shell horizontal layout center">
      <div id="container">
        <h2>Stay connected</h2>
        <p>We'd like to let you know when the network goes live and about other important events.</p>
        <section id="pushPanel" style="display: none;">
          <p>
            <button on-click="enableNotifications">Enable push notifications</button>
          </p>
          <p>or give us your email address and we will keep you updated</p>
        </section>
        <soso-text-input id="email" type="email" label="Email" placeholder="Your email" on-input="_onInput"></soso-text-input>
        <p>
          <button id="btnSubmit" on-click="submitEmail" disabled>Submit</button>
        </p>
        <p>
          <button on-click="skip">I don't want any notifications</button>
        </p>
      </div>
    </div>
  </template>
  <script>
    class NotificationsView extends Polymer.Element {
      static get is() { return "notifications-view"; }

      onActivate() {
        this._active = true;
        this.$.email.value = "";
        this._onInput();
        if (!$core.hasKey) {
          setTimeout(() => {
            $router.goto("");
          }, 600);
          return;
        }

        var isChrome = navigator.userAgent.indexOf('Chrome') > -1;
        var isFirefox = navigator.userAgent.indexOf('Firefox') > -1;
        if (isChrome || isFirefox) {
          this.$.pushPanel.style.display = "";
        } else {
          this.$.pushPanel.style.display = "none";
        }
      }

      onDeactivate() {
        this._active = false;
      }

      _onInput() {
        let valid = this.$.email.value.trim() ? true : false;
        this.$.btnSubmit.disabled = !valid;
      }

      skip() {
        $router.goto("launch");
      }

      submitEmail() {
        let email = this.$.email.value.trim();
        if (!email) {
          this._onInput();
        } else {
          let p = $core.profile;
          $core.updateUserProfile(p.name, p.handle, p.location, null, email).then(() => {
            this.skip();
          }).catch((err) => {
            console.error();
            this.skip();
          });
        }
      }

      enableNotifications() {
        OneSignal.push(() => {
          var isPushSupported = OneSignal.isPushNotificationsSupported();
          if (!isPushSupported) {
            window.alert("Sorry. Push notifications are not supported on your browser.");
          } else {
            OneSignal.push(() => {
              OneSignal.isPushNotificationsEnabled().then((isEnabled) => {
                if (isEnabled) {
                  this.skip();
                  return;
                }

                if (!this._oneSignalHooked) {
                  OneSignal.push(() => {
                    OneSignal.on("subscriptionChange", (isSubscribed) => {
                      if (isSubscribed && this._active) {
                        this.skip();
                      }
                      this._registerDevice();
                    });
                  });
                  this._oneSignalHooked = true;
                }

                OneSignal.push(function () {
                  OneSignal.registerForPushNotifications();
                });
              });
            });
          }
        });
      }

      _registerDevice() {
        OneSignal.push(() => {
          OneSignal.getUserId().then((userid) => {
            if (userid) {
              $core.registerDevice(userid).then(() => { });
            }
          }).catch((err) => {
            console.error(err);
          })
        });
      }
    }
    window.customElements.define(NotificationsView.is, NotificationsView);
  </script>
</dom-module>