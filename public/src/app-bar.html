<link rel="import" href="app-icons.html" async>

<dom-module id="app-bar">
  <template>
    <style is="custom-style" include="app-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        background: rgba(33, 33, 33, 1);
      }

      .logo {
        display: block;
        height: 40px;
      }

      button {
        color: white;
        font-size: 14px;
      }

      button:hover {
        color: var(--highlight-blue);
      }

      .selected {
        color: var(--highlight-blue);
        font-weight: bold;
      }

      #balancePanel {
        height: 60px;
        padding: 0 16px;
        background: var(--bg-yellow);
        color: #000;
        cursor: pointer;
        margin-left: 10px;
      }

      a:hover {
        box-shadow: none;
      }

      #iconsBar {
        display: none;
      }

      @media (max-width: 600px) {
        #logoLink,
        #spacer,
        #linksBar {
          display: none;
        }
        #iconsBar {
          display: flex;
        }
        #container {
          padding: 0 0 0 5px;
        }
        button {
          letter-spacing: initial;
          font-size: 10px;
        }
        #balancePanel {
          letter-spacing: initial;
          margin-left: 2px;
          padding: 0 5px;
          font-size: 15px;
        }
      }

      .mainBar {
        height: 60px;
        padding: 0 0 0 16px;
      }

      #feedsBar {
        padding: 0 0 0 16px;
        background-color: #333;
        height: 40px;
      }
    </style>
    <div id="container" on-click="_onClick">
      <div class="mainBar horizontal layout center">
        <a id="logoLink" href="/">
          <img class="logo" alt="channels" src="/s/images/logos/logo_full_60.png">
        </a>
        <div id="spacer" class="flex"></div>
        <div id="linksBar" class="horizontal layout center">
          <a href="/">
            <button id="home">Home</button>
          </a>
          <a href="#feed">
            <button id="feed">Feed</button>
          </a>
          <a href="#launch">
            <button id="launch">Launch</button>
          </a>
          <a href="https://medium.com/channels-network" target="_blank">
            <button id="blog">Blog</button>
          </a>
          <a id="accountLink" href="#account" style="display:none;">
            <button id="account">Account</button>
          </a>
          <a id="signInLink" href="#signin" style="display:none;">
            <button id="signin">Sign In</button>
          </a>
        </div>
        <div id="iconsBar" class="flex horizontal layout center">
          <a class="flex" href="/">
            <button>
              <iron-icon icon="ch:home"></iron-icon>
              <div>Home</div>
            </button>
          </a>
          <a class="flex" href="#feed">
            <button id="ifeed">
              <iron-icon icon="ch:apps"></iron-icon>
              <div>Feed</div>
            </button>
          </a>
          <a class="flex" href="#launch">
            <button id="ilaunch">
              <iron-icon icon="ch:near-me"></iron-icon>
              <div>Launch</div>
            </button>
          </a>
          <a id="accountButton" class="flex" href="#account">
            <button id="iaccount">
              <iron-icon icon="ch:account-circle"></iron-icon>
              <div>Account</div>
            </button>
          </a>
          <a id="signInButton" class="flex" href="#signin">
            <button id="isignin">
              <iron-icon icon="ch:account-circle"></iron-icon>
              <div>Sign In</div>
            </button>
          </a>
          <!-- <a class="flex" href="https://medium.com/channels-network" target="_blank"><button><iron-icon icon="ch:description"></iron-icon><div>Blog</div></button></a> -->
        </div>
        <a href="#balance">
          <div id="balancePanel" class="horizontal layout center">[[balance]]</div>
        </a>
      </div>
      <div id="feedsBar" class="horizontal layout center">
        <a href="#feed/recommended">
          <button id="recommended">Recommended</button>
        </a>
        <a href="#feed/new">
          <button id="new">New</button>
        </a>
        <a href="#feed/top">
          <button id="top">Top</button>
        </a>
        <a href="#feed/mine">
          <button id="mine">Mine</button>
        </a>
        <a href="#feed/opened">
          <button id="opened">Opened</button>
        </a>
      </div>
    </div>
  </template>
  <script>
    class AppBar extends Polymer.Element {
      static get is() { return "app-bar"; }
      static get properties() {
        return {
          balance: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        if ($core.registration) {
          this._refreshBalance($core.registration);
        }
        window.addEventListener("channels-registration", (event) => {
          var reg = event.detail;
          if (reg) {
            this._refreshBalance(reg);
          }
        });
        window.addEventListener("channels-profile", (event) => {
          this._refreshSignIn();
        });
        window.addEventListener("channels-user-status", (event) => {
          this._refreshBalance();
        });
        setInterval(() => {
          this._refreshBalance();
        }, 1000);
      }

      _refreshSignIn() {
        if ($core.profile && $core.profile.handle) {
          this.$.accountLink.style.display = "";
          this.$.accountButton.style.display = "";
          this.$.signInLink.style.display = "none";
          this.$.signInButton.style.display = "none";
        } else {
          this.$.accountLink.style.display = "none";
          this.$.accountButton.style.display = "none";
          this.$.signInLink.style.display = "";
          this.$.signInButton.style.display = "";
        }
      }

      _refreshBalance() {
        this.balance = "â„‚" + this._truncateBalance($core.balance);
      }

      _truncateBalance(value) {
        if (!value) {
          return "0.000";
        }
        return (Math.floor(value * 1000) / 1000).toFixed(3);
      }

      _onClick(event) {
        event.stopPropagation();
      }

      onRoute(route) {
        var path = route.segments[0];
        this.$.feedsBar.style.display = "none";
        var matches = [];
        if (path) {
          let m = this.$[path];
          let im = this.$['i' + path];
          if (m) {
            matches.push(m);
          }
          if (im) {
            matches.push(im);
          }
          if (path === 'feed') {
            this.$.feedsBar.style.display = "";
            this.$.recommended.classList.remove("selected");
            this.$.new.classList.remove("selected");
            this.$.top.classList.remove("selected");
            this.$.mine.classList.remove("selected");
            this.$.opened.classList.remove("selected");
            if (route.segments.length > 1) {
              if (this.$[route.segments[1]]) {
                this.$[route.segments[1]].classList.add("selected");
              } else {
                this.$.recommended.classList.add("selected");
              }
            } else {
              this.$.recommended.classList.add("selected");
            }
          }
        }
        if (this._prevMatches && this._prevMatches.length) {
          for (var i = 0; i < this._prevMatches.length; i++) {
            this._prevMatches[i].classList.remove("selected");
          }
        }
        this._prevMatches = matches;
        if (matches.length) {
          for (var i = 0; i < matches.length; i++) {
            matches[i].classList.add("selected");
          }
        }
      }
    }
    window.customElements.define(AppBar.is, AppBar);
  </script>
</dom-module>