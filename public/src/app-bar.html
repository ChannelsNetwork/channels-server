<link rel="import" href="app-icons.html" async>
<dom-module id="app-bar">
  <template>
    <style is="custom-style" include="app-styles2">
      :host {
        display: block;
        background: #213034;
        color: white;
      }

      #container {
        height: 60px;
        padding: 0 0 0 16px;
      }

      .logo {
        display: block;
        height: 40px;
        width: auto;
      }

      button {
        color: white;
        font-size: 14px;
        background: none;
        font-weight: 400;
      }

      button:hover {
        color: var(--bg-yellow);
      }

      .selected {
        color: var(--bg-yellow);
        font-weight: bold;
      }

      #balancePanel {
        height: 60px;
        padding: 0 16px;
        background: var(--bg-yellow);
        color: #000;
        cursor: pointer;
        margin-left: 10px;
      }

      a {
        text-align: center;
      }

      a:hover {
        box-shadow: none;
      }

      #iconsBar {
        display: none;
      }

      #iconsBar button:hover {
        color: white;
      }

      @media (max-width: 600px) {
        #container {
          padding: 0 0 0 5px;
        }
        #logoLink,
        #spacer,
        #linksBar {
          display: none;
        }
        #iconsBar {
          display: flex;
        }
        button {
          letter-spacing: initial;
          font-size: 10px;
        }
        #balancePanel {
          letter-spacing: initial;
          margin-left: 2px;
          padding: 0 10px;
          font-size: 15px;
        }
      }
    </style>
    <div id="container" class="horizontal layout center" on-click="_onClick">
      <a id="logoLink" href="/">
        <img class="logo" alt="channels" src="/s/images/logos/logo_full_40.png">
      </a>
      <div id="spacer" class="flex"></div>
      <div id="linksBar" class="horizontal layout center">
        <a href="#feed">
          <button id="feed">Feed</button>
        </a>
        <a href="#about">
          <button id="about">About</button>
        </a>
        <a id="accountLink" href="#account" class="hidden">
          <button id="account">Account</button>
        </a>
        <a id="signInLink" href="#signin">
          <button id="signin">Sign In</button>
        </a>
      </div>
      <div id="iconsBar" class="flex horizontal layout center">
        <a class="flex" href="#feed">
          <button id="ifeed">
            <iron-icon icon="ch:apps"></iron-icon>
            <div>Feed</div>
          </button>
        </a>
        <a class="flex" href="#about">
          <button>
            <iron-icon icon="ch:home"></iron-icon>
            <div>About</div>
          </button>
        </a>
        <a id="accountButton" class="flex hidden" href="#account">
          <button id="iaccount">
            <iron-icon icon="ch:account-circle"></iron-icon>
            <div>Account</div>
          </button>
        </a>
        <a id="signInButton" class="flex" href="#signin">
          <button id="isignin">
            <iron-icon icon="ch:account-circle"></iron-icon>
            <div>Sign In</div>
          </button>
        </a>
      </div>
      <a href="#balance">
        <div id="balancePanel" class="horizontal layout center">[[balance]]</div>
      </a>
    </div>
  </template>
  <script>
    class AppBar extends Polymer.Element {
      static get is() { return "app-bar"; }
      static get properties() {
        return {
          balance: String
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.balance = "ℂ0.000";
        if ($core.registration) {
          this._refreshBalance($core.registration);
        }
        window.addEventListener("channels-registration", (event) => {
          var reg = event.detail;
          if (reg) {
            this._refreshBalance(reg);
          }
        });
        window.addEventListener("channels-profile", (event) => {
          this._refreshSignIn();
        });
        window.addEventListener("channels-user-status", (event) => {
          this._refreshBalance();
        });
        setInterval(() => {
          this._refreshBalance();
        }, 1000);
      }

      _refreshSignIn() {
        if ($core.profile && $core.profile.handle) {
          this.$.accountLink.classList.remove("hidden");
          this.$.accountButton.classList.remove("hidden");
          this.$.signInLink.classList.add("hidden");
          this.$.signInButton.classList.add("hidden");
        } else {
          this.$.accountLink.classList.add("hidden");
          this.$.accountButton.classList.add("hidden");
          this.$.signInLink.classList.remove("hidden");
          this.$.signInButton.classList.remove("hidden");
        }
      }

      _refreshBalance() {
        this.balance = "ℂ" + this._truncateBalance($core.balance);
      }

      _truncateBalance(value) {
        if (!value) {
          return "0.000";
        }
        return (Math.floor(value * 1000) / 1000).toFixed(3);
      }

      _onClick(event) {
        event.stopPropagation();
      }

      onRoute(route) {
        var path = route.segments[0];
        var matches = [];
        if (path) {
          let m = this.$[path];
          let im = this.$['i' + path];
          if (m) {
            matches.push(m);
          }
          if (im) {
            matches.push(im);
          }
        }
        if (this._prevMatches && this._prevMatches.length) {
          for (var i = 0; i < this._prevMatches.length; i++) {
            this._prevMatches[i].classList.remove("selected");
          }
        }
        this._prevMatches = matches;
        if (matches.length) {
          for (var i = 0; i < matches.length; i++) {
            matches[i].classList.add("selected");
          }
        }
      }
    }
    window.customElements.define(AppBar.is, AppBar);
  </script>
</dom-module>