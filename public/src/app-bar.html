<link rel="import" href="channel-icons.html">
<dom-module id="app-bar">
  <template>
    <style is="custom-style" include="app-styles">
      :host {
        display: block;
        background: #213034;
        color: white;
        height: 60px;
        transition: top 0.3s ease, height 0.5s ease;
        position: relative;
      }

      #container {
        height: 60px;
        padding: 0 0 0 16px;
        transition: opacity 0.3s ease;
      }

      .mute {
        pointer-events: none;
        opacity: 0;
      }

      .logo {
        display: block;
        height: 40px;
        width: auto;
      }

      button {
        color: white;
        font-size: 14px;
        background: none;
        font-weight: 400;
      }

      button:hover {
        color: var(--bg-yellow);
      }

      .selected {
        color: var(--bg-yellow) !important;
        font-weight: bold;
      }

      #balancePanel {
        height: 60px;
        padding: 0 16px;
        background: var(--bg-yellow);
        color: #000;
        cursor: pointer;
        margin-left: 10px;
      }

      a {
        text-align: center;
      }

      a:hover {
        box-shadow: none;
      }

      #iconsBar {
        display: none;
      }

      #iconsBar button:hover {
        color: white;
      }

      @media (max-width: 600px) {
        #container {
          padding: 0 0 0 5px;
        }
        #logoLink,
        #spacer,
        #linksBar {
          display: none;
        }
        #iconsBar {
          display: flex;
        }
        button {
          letter-spacing: initial;
          font-size: 10px;
        }
        #balancePanel {
          letter-spacing: initial;
          margin-left: 2px;
          padding: 0 10px;
          font-size: 15px;
        }
      }

      #feedsBar {
        padding: 0 16px;
        background-color: #333;
        height: 40px;
      }
    </style>
    <div id="container" class="horizontal layout center">
      <a id="logoLink" href="/">
        <img class="logo" alt="channels" src="/s/images/logos/logo_full_40.png">
      </a>
      <div id="spacer" class="flex"></div>
      <div id="linksBar" class="horizontal layout center">
        <a href="/feed">
          <button id="feed">Feed</button>
        </a>
        <a href="/about">
          <button id="about">About</button>
        </a>
        <a id="accountLink" href="/account" class="hidden">
          <button id="account">Account</button>
        </a>
        <a id="signInLink" href="/signin">
          <button id="signin">Sign In</button>
        </a>
        <a id="searchLink" href="/search">
          <button id="search">
            <soso-icon icon="search" icon-map="[[iconMap]]"></soso-icon>
          </button>
        </a>
      </div>
      <div id="iconsBar" class="flex horizontal layout center">
        <a class="flex" href="/feed">
          <button id="ifeed">
            <soso-icon icon="apps" icon-map="[[iconMap]]"></soso-icon>
            <div>Feed</div>
          </button>
        </a>
        <a class="flex" href="/about">
          <button id="iabout">
            <soso-icon icon="info" icon-map="[[iconMap]]"></soso-icon>
            <div>About</div>
          </button>
        </a>
        <a id="accountButton" class="flex hidden" href="/account">
          <button id="iaccount">
            <soso-icon icon="account" icon-map="[[iconMap]]"></soso-icon>
            <div>Account</div>
          </button>
        </a>
        <a id="signInButton" class="flex" href="/signin">
          <button id="isignin">
            <soso-icon icon="account" icon-map="[[iconMap]]"></soso-icon>
            <div>Sign In</div>
          </button>
        </a>
        <a id="searchButton" class="flex" href="/search">
          <button id="isearch">
            <soso-icon icon="search" icon-map="[[iconMap]]"></soso-icon>
            <div>Search</div>
          </button>
        </a>
      </div>
      <a href="/balance">
        <div id="balancePanel" class="horizontal layout center">
          <span id="balanceLabel" style="opacity: 0;">[[balance]]</span>
        </div>
      </a>
    </div>
    <div id="feedsBar" class="flex horizontal layout center hidden">
      <a href="/feed/recommended">
        <button id="recommended">Recommended</button>
      </a>
      <a href="/browse">
        <button id="browse">Browse</button>
      </a>
      <a href="/feed/new">
        <button id="new">New</button>
      </a>
      <a href="/feed/top">
        <button id="top">Top</button>
      </a>
      <a href="/feed/opened">
        <button id="opened">Opened</button>
      </a>
      <a id="mineLink" href="/feed/mine" class="hidden">
        <button id="mine">Mine</button>
      </a>
    </div>
  </template>
  <script>
    class AppBar extends Polymer.Element {
      static get is() { return "app-bar"; }
      static get properties() {
        return {
          balance: String,
          iconMap: Object,
          _pending: Boolean
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.balance = "ℂ0.000";
        this.iconMap = window._channelIcons;
        window.addEventListener("channels-registration", (event) => {
          this._updateBalance();
        });
        window.addEventListener("channels-profile", (event) => {
          this._refreshSignIn();
        });
        window.addEventListener("channels-user-status", (event) => {
          this._updateBalance();
        });
      }

      _refreshSignIn() {
        if ($core.profile && $core.profile.handle) {
          this.$.accountLink.classList.remove("hidden");
          this.$.accountButton.classList.remove("hidden");
          this.$.mineLink.classList.remove("hidden");
          this.$.signInLink.classList.add("hidden");
          this.$.signInButton.classList.add("hidden");
        } else {
          this.$.accountLink.classList.add("hidden");
          this.$.accountButton.classList.add("hidden");
          this.$.mineLink.classList.add("hidden");
          this.$.signInLink.classList.remove("hidden");
          this.$.signInButton.classList.remove("hidden");
        }
      }

      _updateBalance() {
        if (!this._balanceTimer) {
          this._balanceTimer = setInterval(() => {
            this._refreshBalance();
          }, 2000);
        }
        this._refreshBalance();
        this.$.balanceLabel.style.opacity = 1;
      }

      _refreshBalance() {
        this.balance = "ℂ" + this._truncateBalance($core.balance);
      }

      _truncateBalance(value) {
        if (!value) {
          return "0.000";
        }
        return (Math.floor(value * 1000) / 1000).toFixed(3);
      }

      onRoute(route) {
        this.$.feedsBar.classList.add("hidden");
        var path = route.segments[0];
        var matches = [];
        if (path) {
          let m = this.$[path];
          let im = this.$['i' + path];
          if (m) {
            matches.push(m);
          }
          if (im) {
            matches.push(im);
          }
          if (path === 'feed') {
            this._showFeedsBar(route.segments[1] || "");
          } else if (path === 'browse') {
            this._showFeedsBar('browse');
          }
        } else {
          this._showFeedsBar("");
        }
        if (this._prevMatches && this._prevMatches.length) {
          for (var i = 0; i < this._prevMatches.length; i++) {
            this._prevMatches[i].classList.remove("selected");
          }
        }
        this._prevMatches = matches;
        if (matches.length) {
          for (var i = 0; i < matches.length; i++) {
            matches[i].classList.add("selected");
          }
        }
      }

      _showFeedsBar(subpath) {
        this.$.feedsBar.classList.remove("hidden");
        this.$.recommended.classList.remove("selected");
        this.$.browse.classList.remove("selected");
        this.$.new.classList.remove("selected");
        this.$.top.classList.remove("selected");
        this.$.mine.classList.remove("selected");
        this.$.opened.classList.remove("selected");
        if (subpath && this.$[subpath]) {
          this.$[subpath].classList.add("selected");
        } else {
          this.$.recommended.classList.add("selected");
        }
      }
    }
    window.customElements.define(AppBar.is, AppBar);
  </script>
</dom-module>