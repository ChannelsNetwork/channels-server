<dom-module id="compose-card-content">
  <template>
    <style is="custom-style" include="app-styles2">
      :host {
        display: block;
      }

      .buttons {
        margin-top: 40px;
        text-align: center;
      }

      #cancel {
        margin-right: 10px;
      }
    </style>
    <div id="container"></div>
    <div class="buttons">
      <button id="cancel" on-click="_onCancel">Cancel</button>
      <button id="next" disabled on-click="_onNext">Next</button>
    </div>
  </template>
  <script>
    class ComposeCardContent extends Polymer.Element {
      static get is() { return 'compose-card-content'; }
      static get properties() {
        return {
          wizard: Object
        };
      }

      _clearNode(node) {
        while (node.hasChildNodes()) {
          node.removeChild(node.lastChild);
        }
      }

      _onCancel() {
        this.wizard.cancel();
      }

      _onNext() {
        this.wizard.next();
      }

      onTransitioningIn(forward) {
        if (!this.wizard.data.cardInfo) {
          this.composer = null;
        }
        let repo = this.wizard.data.repo;
        if (this._prevRepo != repo) {
          this.composer = null;
        }
        this._prevRepo = repo;

        if (!this.composer) {
          this._clearNode(this.$.container);
          let cardInfo = this.wizard.data.cardInfo;
          if (cardInfo) {
            Polymer.importHref(cardInfo.importHref, () => {
              this.composer = document.createElement(cardInfo.channelComponent.composerTag);
              this.composer.services = $core.cardManager.cardService;
              this.$.container.appendChild(this.composer);
              this.$.next.disabled = false;
              this.composer.addEventListener('state-ready-change', () => {
                if (this.composer.isReady) {
                  this._enableNext(true);
                } else {
                  this._enableNext(false);
                }
              });
              if (this.composer.isReady) {
                this._enableNext(true);
              } else {
                this._enableNext(false);
              }
            }, (err) => {
              this._enableNext(false);
            });
          } else {
            this._enableNext(false);
          }
        }
      }

      _enableNext(enable) {
        this.$.next.disabled = !enable;
        this.dispatchEvent(new CustomEvent(enable ? 'next-enable' : 'next-disable', { bubbles: true, composed: true }));
      }

      onTransitioningOut(forward) {
        return new Promise((resolve, reject) => {
          if (!forward) {
            resolve();
          } else {
            if (this.composer) {
              this.wizard.data.cardSharedState = this.composer.sharedState || {};
              this.wizard.data.summary = this.composer.summary || {};
            }
            resolve();
          }
        });
      }
    }
    window.customElements.define(ComposeCardContent.is, ComposeCardContent);
  </script>
</dom-module>